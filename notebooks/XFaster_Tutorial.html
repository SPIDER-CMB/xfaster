

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>Tutorial &mdash; xfaster 0.1 documentation</title>
  

  
  <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../_static/pygments.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../" src="../_static/documentation_options.js"></script>
        <script src="../_static/jquery.js"></script>
        <script src="../_static/underscore.js"></script>
        <script src="../_static/doctools.js"></script>
        <script src="../_static/language_data.js"></script>
        <script crossorigin="anonymous" integrity="sha256-Ae2Vz/4ePdIu6ZyI/5ZGsYnb+m0JlOmKPjt6XZ9JJkA=" src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.4/require.min.js"></script>
        <script async="async" src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/latest.js?config=TeX-AMS-MML_HTMLorMML"></script>
        <script type="text/x-mathjax-config">MathJax.Hub.Config({"TeX": {"equationNumbers": {"autoNumber": "AMS", "useLabelIds": true}}, "tex2jax": {"inlineMath": [["$", "$"], ["\\(", "\\)"]], "processEscapes": true, "ignoreClass": "document", "processClass": "math|output_area"}})</script>
    
    <script type="text/javascript" src="../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../genindex.html" />
    <link rel="search" title="Search" href="../search.html" />
    <link rel="next" title="API Reference" href="../api.html" />
    <link rel="prev" title="Algorithm" href="../algorithm.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../index.html" class="icon icon-home"> xfaster
          

          
          </a>

          
            
            
              <div class="version">
                0.1
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption"><span class="caption-text">Contents:</span></p>
<ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../quickstart.html">Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../algorithm.html">Algorithm</a></li>
<li class="toctree-l1 current"><a class="current reference internal" href="#">Tutorial</a><ul>
<li class="toctree-l2"><a class="reference internal" href="#The-main-ingredients-of-the-XFaster-code">The main ingredients of the XFaster code</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Specifying-what-data-to-use">Specifying what data to use</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Step-by-step-through-the-functions-called-in-xfaster_exec">Step by step through the functions called in xfaster_exec</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#get_files">get_files</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get_bin_def">get_bin_def</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get_mask_weights">get_mask_weights</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get_kernels">get_kernels</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get_masked_sims">get_masked_sims</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get_beams">get_beams</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get_signal_shape">get_signal_shape</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get_transfer">get_transfer</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get_bin_def-(round-2)">get_bin_def (round 2)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get_masked_xcorr">get_masked_xcorr</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get_masked_sims-(round-2)">get_masked_sims (round 2)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get_beams-(round-2)">get_beams (round 2)</a></li>
<li class="toctree-l3"><a class="reference internal" href="#get_bandpowers">get_bandpowers</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#Constructing-the-model-spectrum">Constructing the model spectrum</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Computing-the-Fisher-matrix">Computing the Fisher matrix</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Inverting-the-Fisher-matrix">Inverting the Fisher matrix</a></li>
<li class="toctree-l4"><a class="reference internal" href="#Constructing-final-bandpowers">Constructing final bandpowers</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="#Looking-at-results">Looking at results</a></li>
<li class="toctree-l2"><a class="reference internal" href="#Other-useful-things">Other useful things</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../api.html">API Reference</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../index.html">xfaster</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../index.html" class="icon icon-home"></a> &raquo;</li>
        
      <li>Tutorial</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
          
            <a href="../_sources/notebooks/XFaster_Tutorial.ipynb.txt" rel="nofollow"> View page source</a>
          
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  
<style>
/* CSS for nbsphinx extension */

/* remove conflicting styling from Sphinx themes */
div.nbinput.container div.prompt *,
div.nboutput.container div.prompt *,
div.nbinput.container div.input_area pre,
div.nboutput.container div.output_area pre,
div.nbinput.container div.input_area .highlight,
div.nboutput.container div.output_area .highlight {
    border: none;
    padding: 0;
    margin: 0;
    box-shadow: none;
}

div.nbinput.container > div[class*=highlight],
div.nboutput.container > div[class*=highlight] {
    margin: 0;
}

div.nbinput.container div.prompt *,
div.nboutput.container div.prompt * {
    background: none;
}

div.nboutput.container div.output_area .highlight,
div.nboutput.container div.output_area pre {
    background: unset;
}

div.nboutput.container div.output_area div.highlight {
    color: unset;  /* override Pygments text color */
}

/* avoid gaps between output lines */
div.nboutput.container div[class*=highlight] pre {
    line-height: normal;
}

/* input/output containers */
div.nbinput.container,
div.nboutput.container {
    display: -webkit-flex;
    display: flex;
    align-items: flex-start;
    margin: 0;
    width: 100%;
}
@media (max-width: 540px) {
    div.nbinput.container,
    div.nboutput.container {
        flex-direction: column;
    }
}

/* input container */
div.nbinput.container {
    padding-top: 5px;
}

/* last container */
div.nblast.container {
    padding-bottom: 5px;
}

/* input prompt */
div.nbinput.container div.prompt pre {
    color: #307FC1;
}

/* output prompt */
div.nboutput.container div.prompt pre {
    color: #BF5B3D;
}

/* all prompts */
div.nbinput.container div.prompt,
div.nboutput.container div.prompt {
    width: 4.5ex;
    padding-top: 5px;
    position: relative;
    user-select: none;
}

div.nbinput.container div.prompt > div,
div.nboutput.container div.prompt > div {
    position: absolute;
    right: 0;
    margin-right: 0.3ex;
}

@media (max-width: 540px) {
    div.nbinput.container div.prompt,
    div.nboutput.container div.prompt {
        width: unset;
        text-align: left;
        padding: 0.4em;
    }
    div.nboutput.container div.prompt.empty {
        padding: 0;
    }

    div.nbinput.container div.prompt > div,
    div.nboutput.container div.prompt > div {
        position: unset;
    }
}

/* disable scrollbars on prompts */
div.nbinput.container div.prompt pre,
div.nboutput.container div.prompt pre {
    overflow: hidden;
}

/* input/output area */
div.nbinput.container div.input_area,
div.nboutput.container div.output_area {
    -webkit-flex: 1;
    flex: 1;
    overflow: auto;
}
@media (max-width: 540px) {
    div.nbinput.container div.input_area,
    div.nboutput.container div.output_area {
        width: 100%;
    }
}

/* input area */
div.nbinput.container div.input_area {
    border: 1px solid #e0e0e0;
    border-radius: 2px;
    /*background: #f5f5f5;*/
}

/* override MathJax center alignment in output cells */
div.nboutput.container div[class*=MathJax] {
    text-align: left !important;
}

/* override sphinx.ext.imgmath center alignment in output cells */
div.nboutput.container div.math p {
    text-align: left;
}

/* standard error */
div.nboutput.container div.output_area.stderr {
    background: #fdd;
}

/* ANSI colors */
.ansi-black-fg { color: #3E424D; }
.ansi-black-bg { background-color: #3E424D; }
.ansi-black-intense-fg { color: #282C36; }
.ansi-black-intense-bg { background-color: #282C36; }
.ansi-red-fg { color: #E75C58; }
.ansi-red-bg { background-color: #E75C58; }
.ansi-red-intense-fg { color: #B22B31; }
.ansi-red-intense-bg { background-color: #B22B31; }
.ansi-green-fg { color: #00A250; }
.ansi-green-bg { background-color: #00A250; }
.ansi-green-intense-fg { color: #007427; }
.ansi-green-intense-bg { background-color: #007427; }
.ansi-yellow-fg { color: #DDB62B; }
.ansi-yellow-bg { background-color: #DDB62B; }
.ansi-yellow-intense-fg { color: #B27D12; }
.ansi-yellow-intense-bg { background-color: #B27D12; }
.ansi-blue-fg { color: #208FFB; }
.ansi-blue-bg { background-color: #208FFB; }
.ansi-blue-intense-fg { color: #0065CA; }
.ansi-blue-intense-bg { background-color: #0065CA; }
.ansi-magenta-fg { color: #D160C4; }
.ansi-magenta-bg { background-color: #D160C4; }
.ansi-magenta-intense-fg { color: #A03196; }
.ansi-magenta-intense-bg { background-color: #A03196; }
.ansi-cyan-fg { color: #60C6C8; }
.ansi-cyan-bg { background-color: #60C6C8; }
.ansi-cyan-intense-fg { color: #258F8F; }
.ansi-cyan-intense-bg { background-color: #258F8F; }
.ansi-white-fg { color: #C5C1B4; }
.ansi-white-bg { background-color: #C5C1B4; }
.ansi-white-intense-fg { color: #A1A6B2; }
.ansi-white-intense-bg { background-color: #A1A6B2; }

.ansi-default-inverse-fg { color: #FFFFFF; }
.ansi-default-inverse-bg { background-color: #000000; }

.ansi-bold { font-weight: bold; }
.ansi-underline { text-decoration: underline; }


div.nbinput.container div.input_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight] > pre,
div.nboutput.container div.output_area div[class*=highlight].math,
div.nboutput.container div.output_area.rendered_html,
div.nboutput.container div.output_area > div.output_javascript,
div.nboutput.container div.output_area:not(.rendered_html) > img{
    padding: 5px;
    margin: 0;
}

/* fix copybtn overflow problem in chromium (needed for 'sphinx_copybutton') */
div.nbinput.container div.input_area > div[class^='highlight'],
div.nboutput.container div.output_area > div[class^='highlight']{
    overflow-y: hidden;
}

/* hide copybtn icon on prompts (needed for 'sphinx_copybutton') */
.prompt a.copybtn {
    display: none;
}

/* Some additional styling taken form the Jupyter notebook CSS */
div.rendered_html table {
  border: none;
  border-collapse: collapse;
  border-spacing: 0;
  color: black;
  font-size: 12px;
  table-layout: fixed;
}
div.rendered_html thead {
  border-bottom: 1px solid black;
  vertical-align: bottom;
}
div.rendered_html tr,
div.rendered_html th,
div.rendered_html td {
  text-align: right;
  vertical-align: middle;
  padding: 0.5em 0.5em;
  line-height: normal;
  white-space: normal;
  max-width: none;
  border: none;
}
div.rendered_html th {
  font-weight: bold;
}
div.rendered_html tbody tr:nth-child(odd) {
  background: #f5f5f5;
}
div.rendered_html tbody tr:hover {
  background: rgba(66, 165, 245, 0.2);
}

/* CSS overrides for sphinx_rtd_theme */

/* 24px margin */
.nbinput.nblast.container,
.nboutput.nblast.container {
    margin-bottom: 19px;  /* padding has already 5px */
}

/* ... except between code cells! */
.nblast.container + .nbinput.container {
    margin-top: -19px;
}

.admonition > p:before {
    margin-right: 4px;  /* make room for the exclamation icon */
}

/* Fix math alignment, see https://github.com/rtfd/sphinx_rtd_theme/pull/686 */
.math {
    text-align: unset;
}
</style>
<div class="section" id="Tutorial">
<h1>Tutorial<a class="headerlink" href="#Tutorial" title="Permalink to this headline">¶</a></h1>
<p>This tutorial is also a Jupyter notebook, which can be found in <a class="reference external" href="https://github.com/annegambrel/xfaster/tree/main/example/notebooks">the example notebooks directory</a>.</p>
<div class="section" id="The-main-ingredients-of-the-XFaster-code">
<h2>The main ingredients of the XFaster code<a class="headerlink" href="#The-main-ingredients-of-the-XFaster-code" title="Permalink to this headline">¶</a></h2>
<p>Before we get into the functions that produce each of the components that gets fed into equations <span class="math">\ref{eq:qb}</span> and <span class="math">\ref{eq:fisher}</span>, let’s first talk about how XFaster is structured and what it expects as inputs.</p>
<p>There are two main python modules in XFaster: <code class="docutils literal notranslate"><span class="pre">xfaster_exec.py</span></code> and <code class="docutils literal notranslate"><span class="pre">xfaster_class.py</span></code>. <code class="docutils literal notranslate"><span class="pre">xfaster_exec</span></code> was written to mirror <code class="docutils literal notranslate"><span class="pre">unimap_exec</span></code>. It contains two main functions: <code class="docutils literal notranslate"><span class="pre">xfaster_run</span></code> and <code class="docutils literal notranslate"><span class="pre">xfaster_submit</span></code>. <code class="docutils literal notranslate"><span class="pre">xfaster_run</span></code> calls all of the functions to make XFaster happen (all located in <code class="docutils literal notranslate"><span class="pre">xfaster_class</span></code>) in the order they need to happen. <code class="docutils literal notranslate"><span class="pre">xfaster_submit</span></code> takes arguments for submitting the job to a queue. XFaster is not highly parallelized like <code class="docutils literal notranslate"><span class="pre">unimap</span></code>. The only real benefit
it can get from using multiple cores is through the OMP speed up from numpy matrix operations. Therefore, unless you’re drowning in more cores than you know what to do with, I would recommend only using one core for XFaster jobs, and splitting things up as best you can in other ways (ie, if running sims, have a handful of sims per job instead of running them all in series).</p>
<p>There are a few other modules you might interact with: * <code class="docutils literal notranslate"><span class="pre">xfaster_tools.py</span></code>: contains small functions used in xfaster_class * <code class="docutils literal notranslate"><span class="pre">parse_tools.py</span></code>: contains a bunch of tools for converting between data structures, especially between dictionaries and matrices * <code class="docutils literal notranslate"><span class="pre">output_class.py</span></code>: contains tools for parsing data on disk for post-processing. This will only be very useful if you’re looking at XFaster outputs created prior to July 22, 2019, when things were stored as arrays instead of
dictionaries. We would now recommend loading the outputs directly with <code class="docutils literal notranslate"><span class="pre">xfaster.load_and_parse('&lt;output&gt;.npz')</span></code> and grabbing things in the dictionaries there. This is illustrated in the last section of this document.</p>
</div>
<div class="section" id="Specifying-what-data-to-use">
<h2>Specifying what data to use<a class="headerlink" href="#Specifying-what-data-to-use" title="Permalink to this headline">¶</a></h2>
<p>So the top level thing you interact with is <code class="docutils literal notranslate"><span class="pre">xfaster_exec</span></code>, which takes your arguments, and has some reasonable defaults for any you don’t provide. What does it take other than arguments? Maps! It wants a bunch of signal and noise simulations, in addition to the data maps and masks. Rather than pointing to each map individually, we have a directory structure that the code expects. I’ve put the ensemble on labah, and its contents look like this:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[1]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ls</span> <span class="o">../</span><span class="n">maps_example</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
<span class="ansi-blue-intense-fg ansi-bold">signal_synfast</span>/  transfer_example.txt
</pre></div></div>
</div>
<p>Each of data, signal, noise, and mask has a top level directory with a preordained, fixed prefix (<code class="docutils literal notranslate"><span class="pre">data</span></code>, <code class="docutils literal notranslate"><span class="pre">signal</span></code>, <code class="docutils literal notranslate"><span class="pre">noise</span></code>, <code class="docutils literal notranslate"><span class="pre">mask</span></code>) and then some suffix specified by the user which is appended with an underscore. So, for example, to run XFaster on this set of maps, I need to specify in my arguments: <code class="docutils literal notranslate"><span class="pre">clean_type=raw</span></code> (this is a confusing name for a variable, but just remember this designates the data type), <code class="docutils literal notranslate"><span class="pre">signal_type=flatBBDl</span></code>, <code class="docutils literal notranslate"><span class="pre">noise_type=stationary</span></code>,
<code class="docutils literal notranslate"><span class="pre">mask_type=pointsource_latlon_aphalfdeg</span></code>.</p>
<p>Masks have to be named a certain way within the directory (<code class="docutils literal notranslate"><span class="pre">mask_map_&lt;tag&gt;.fits</span></code>) and have to contain both an I and P mask if running XFaster in polarized mode (which you should always be doing). We have always used the same mask for I and P, but it’s not required. You must have a mask file for each map tag, so if I’m doing a run with maps for 90 and 150 GHz maps, I need a mask for each of those, even if it’s the same mask. You can use symlinks to save on disk space in that case.</p>
<p>To indicate which maps I want, I pass the argument <code class="docutils literal notranslate"><span class="pre">data_subset</span></code> a glob-parseable path relative to the top level data directory– in this case, <code class="docutils literal notranslate"><span class="pre">data_raw</span></code>. <a class="reference external" href="https://docs.python.org/3/library/glob.html">Glob</a> works just like the unix shell does for matching file paths, so it is easy to test in advance which maps you’re going to get. Say I want to do a 150 GHz spectrum using the quarter chunks. I’m going to test this first!</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[2]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ls</span> <span class="o">../</span><span class="n">maps_example</span><span class="o">/</span><span class="n">data_raw</span><span class="o">/*</span><span class="mi">150</span><span class="o">*</span> <span class="c1">#nope</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ls: cannot access &#39;../maps_example/data_raw/*150*&#39;: No such file or directory
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[3]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ls</span> <span class="o">../</span><span class="n">maps_example</span><span class="o">/</span><span class="n">data_raw</span><span class="o">/*/*</span><span class="mi">150</span><span class="o">*</span> <span class="c1">#yep-- data_subset=&#39;*/*150*&#39;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ls: cannot access &#39;../maps_example/data_raw/*/*150*&#39;: No such file or directory
</pre></div></div>
</div>
<p>Or instead, if I want to run over all the maps, I would do</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[4]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ls</span> <span class="o">../</span><span class="n">maps_example</span><span class="o">/</span><span class="n">data_raw</span><span class="o">/*/*</span> <span class="c1"># data_subset=&#39;*/*&#39;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ls: cannot access &#39;../maps_example/data_raw/*/*&#39;: No such file or directory
</pre></div></div>
</div>
<p>This is all implemented in <code class="docutils literal notranslate"><span class="pre">_get_files</span></code> like so:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># find all map files</span>
<span class="n">map_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_root</span><span class="p">,</span> <span class="s1">&#39;data_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">clean_type</span><span class="p">))</span>
<span class="n">map_files</span> <span class="o">=</span> <span class="p">[]</span>
<span class="n">data_subset</span> <span class="o">=</span> <span class="n">data_subset</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;,&quot;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">np</span><span class="o">.</span><span class="n">atleast_1d</span><span class="p">(</span><span class="n">data_subset</span><span class="p">):</span>
    <span class="n">map_files</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">map_root</span><span class="p">,</span>
                                            <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))))</span>
<span class="n">map_files</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">map_files</span><span class="p">)</span>
<span class="n">map_files</span> <span class="o">=</span> <span class="p">[</span><span class="n">f</span> <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">map_files</span> <span class="k">if</span>
             <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">)</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;map_&#39;</span><span class="p">)]</span>
<span class="n">map_tags</span> <span class="o">=</span> <span class="p">[</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">splitext</span><span class="p">(</span><span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">basename</span><span class="p">(</span><span class="n">f</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">,</span> <span class="mi">1</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">map_files</span><span class="p">]</span>
</pre></div>
</div>
<p>So you’ve specified which data maps you want to compute power spectra for. A reasonable question would be, does that globbable expression then just get applied to the signal and noise directory to get signal and noise maps? If it did, that would mean my first expression for the 150 GHz maps would also get every 150th sim. Instead, XFaster uses whatever matches it found in data, and tries to match those to maps in the sims directory, with the only difference the sim index that’s appended. Here’s
what that looks like for signal sims, in the same function:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="c1"># find all corresponding signal sims</span>
<span class="n">signal_root</span> <span class="o">=</span> <span class="n">os</span><span class="o">.</span><span class="n">path</span><span class="o">.</span><span class="n">join</span><span class="p">(</span><span class="n">data_root</span><span class="p">,</span> <span class="s1">&#39;signal_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">signal_type</span><span class="p">))</span>
<span class="n">num_signal</span> <span class="o">=</span> <span class="kc">None</span>
<span class="n">signal_files</span> <span class="o">=</span> <span class="p">[]</span>
<span class="k">for</span> <span class="n">f</span> <span class="ow">in</span> <span class="n">map_files</span><span class="p">:</span>
    <span class="n">sfiles</span> <span class="o">=</span> <span class="nb">sorted</span><span class="p">(</span><span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span>
        <span class="n">f</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span><span class="n">map_root</span><span class="p">,</span> <span class="n">signal_root</span><span class="p">)</span><span class="o">.</span><span class="n">replace</span><span class="p">(</span>
            <span class="s1">&#39;.fits&#39;</span><span class="p">,</span> <span class="s1">&#39;_</span><span class="si">{}</span><span class="s1">.fits&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">signal_subset</span><span class="p">))))</span>
    <span class="n">nsims1</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">sfiles</span><span class="p">)</span>
    <span class="k">if</span> <span class="ow">not</span> <span class="n">nsims1</span><span class="p">:</span>
        <span class="k">raise</span> <span class="ne">OSError</span><span class="p">(</span><span class="s1">&#39;Missing signal sims for </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">f</span><span class="p">))</span>
    <span class="n">num_signal</span> <span class="o">=</span> <span class="n">nsims1</span>
    <span class="n">signal_files</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">sfiles</span><span class="p">)</span>
</pre></div>
</div>
<p>It’s easy to get errors at the reading files step. Add log messages around here to see what’s going wrong. XFaster requires that all your maps have the same number of sims, though you are allowed to have a different from of signal and noise sims. In the labah data set, I have 1000 signal and noise sims for SPIDER, but only 200 of each for Planck. So I need to tell XFaster to only use the first 200 signal and noise sims it finds. I can do that using the <code class="docutils literal notranslate"><span class="pre">signal_subset</span></code> and <code class="docutils literal notranslate"><span class="pre">noise_subset</span></code>
arguments, which default to <code class="docutils literal notranslate"><span class="pre">'*'</span></code>. Now, I need to specify (in a glob-parseable manner) which tags that come after <code class="docutils literal notranslate"><span class="pre">map_90_</span></code>, eg, to use. Each sim is indexed with four digits, so <code class="docutils literal notranslate"><span class="pre">map_90_0000.fits,</span> <span class="pre">map_90_0001.fits</span></code>, etc. If I want the first 200 of each sim, I’m first going to test my expression (I’m piping it into a line count to reduce the output, but you don’t have to):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[5]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ls</span> <span class="o">../</span><span class="n">maps_example</span><span class="o">/</span><span class="n">signal_synfast</span><span class="o">/</span><span class="n">full</span><span class="o">/</span><span class="n">map_95_0</span><span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">|</span> <span class="n">wc</span> <span class="o">-</span><span class="n">l</span> <span class="c1"># this won&#39;t work</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ls: cannot access &#39;../maps_example/signal_synfast/full/map_95_0[0-1]&#39;: No such file or directory
0
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[6]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ls</span> <span class="o">../</span><span class="n">maps_example</span><span class="o">/</span><span class="n">signal_synfast</span><span class="o">/</span><span class="n">full</span><span class="o">/</span><span class="n">map_95_0</span><span class="p">[</span><span class="mi">0</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span> <span class="o">|</span> <span class="n">wc</span> <span class="o">-</span><span class="n">l</span> <span class="c1"># yep! signal_subset=&#39;0[0-1]*&#39;;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
ls: cannot access &#39;../maps_example/signal_synfast/full/map_95_0[0-1]*&#39;: No such file or directory
0
</pre></div></div>
</div>
</div>
<div class="section" id="Step-by-step-through-the-functions-called-in-xfaster_exec">
<h2>Step by step through the functions called in xfaster_exec<a class="headerlink" href="#Step-by-step-through-the-functions-called-in-xfaster_exec" title="Permalink to this headline">¶</a></h2>
<p>Now we’ll proceed to stepping through each function in xfaster_exec. You’ll never run the code this way, you’ll just call xfaster_run or xfaster_submit with the arguments that then get passed to these functions. But we’ll do it this way so we can illustrate some of the intermediate data products as we go.</p>
<p>I’ll do a run with all six SPIDER and Planck frequencies. First, we’ll import XFaster and initialize our XFaster class with some arguments.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[7]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">xfaster</span> <span class="k">as</span> <span class="nn">xf</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">colors</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[8]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">X</span> <span class="o">=</span> <span class="n">xf</span><span class="o">.</span><span class="n">XFaster</span><span class="p">(</span><span class="n">config</span><span class="o">=</span><span class="s2">&quot;../config_example.ini&quot;</span><span class="p">,</span> <span class="n">output_root</span><span class="o">=</span><span class="s2">&quot;../outputs_example&quot;</span><span class="p">,</span> <span class="n">verbose</span><span class="o">=</span><span class="s2">&quot;info&quot;</span><span class="p">,</span>
              <span class="n">output_tag</span><span class="o">=</span><span class="s2">&quot;95x150&quot;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="section" id="get_files">
<h3>get_files<a class="headerlink" href="#get_files" title="Permalink to this headline">¶</a></h3>
<p>I’m just going to use the first 100 sims to reduce the time it takes me to run this notebook, but you should use as many sims as are available to you to get the best results.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[9]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">file_opts</span> <span class="o">=</span> <span class="p">{</span>
    <span class="s2">&quot;data_root&quot;</span><span class="p">:</span> <span class="s2">&quot;../maps_example&quot;</span><span class="p">,</span>
    <span class="s2">&quot;data_subset&quot;</span><span class="p">:</span> <span class="s2">&quot;full/*95,full/*150&quot;</span><span class="p">,</span>
    <span class="s2">&quot;data_type&quot;</span><span class="p">:</span> <span class="s2">&quot;raw&quot;</span><span class="p">,</span>
    <span class="s2">&quot;noise_type&quot;</span><span class="p">:</span> <span class="s2">&quot;gaussian&quot;</span><span class="p">,</span>
    <span class="s2">&quot;mask_type&quot;</span><span class="p">:</span> <span class="s2">&quot;rectangle&quot;</span><span class="p">,</span>
    <span class="s2">&quot;signal_type&quot;</span><span class="p">:</span> <span class="s2">&quot;synfast&quot;</span><span class="p">,</span>
<span class="p">}</span>

</pre></div>
</div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[10]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">file_vars</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">get_files</span><span class="p">(</span><span class="o">**</span><span class="n">file_opts</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="get_bin_def">
<h3>get_bin_def<a class="headerlink" href="#get_bin_def" title="Permalink to this headline">¶</a></h3>
<p>Now we set up a dictionary that tells where the edges of the CMB bins are for each spectrum.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[11]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">bd</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">get_bin_def</span><span class="p">(</span><span class="n">bin_width</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">lmin</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">tbeb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">foreground_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">bd</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[12]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
odict_keys([&#39;cmb_tt&#39;, &#39;cmb_ee&#39;, &#39;cmb_bb&#39;, &#39;cmb_te&#39;, &#39;cmb_eb&#39;, &#39;cmb_tb&#39;])
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">bd</span><span class="p">[</span><span class="s1">&#39;cmb_tt&#39;</span><span class="p">]</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[13]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
array([[  2,  27],
       [ 27,  52],
       [ 52,  77],
       [ 77, 102],
       [102, 127],
       [127, 152],
       [152, 177],
       [177, 202],
       [202, 227],
       [227, 252],
       [252, 277],
       [277, 302],
       [302, 327],
       [327, 352],
       [352, 377],
       [377, 402],
       [402, 427],
       [427, 452],
       [452, 477],
       [477, 501]])
</pre></div></div>
</div>
</div>
<div class="section" id="get_mask_weights">
<h3>get_mask_weights<a class="headerlink" href="#get_mask_weights" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[14]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">w_stuff</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">get_mask_weights</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>Notice here that XFaster first checked if a file existed on disk with the information we’re trying to compute. It has a checkpointing system, such that if a file exists with the data you want, it won’t recompute it <em>unless</em> you’ve specified with the <code class="docutils literal notranslate"><span class="pre">checkpoint</span></code> argument that you want to recompute that step. If we did specify <code class="docutils literal notranslate"><span class="pre">checkpoint=masks</span></code>, it would redo the <code class="docutils literal notranslate"><span class="pre">get_mask_weights</span></code> function, and every step beyond that in the pipeline, whether or not they have already been stored to disk.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">w_stuff</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[15]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
dict_keys([&#39;wls&#39;, &#39;fsky&#39;, &#39;w1&#39;, &#39;w2&#39;, &#39;w4&#39;, &#39;gmat&#39;, &#39;nside&#39;, &#39;npix&#39;, &#39;gcorr&#39;, &#39;output_file&#39;])
</pre></div></div>
</div>
<p>The main outputs of this step are the <span class="math notranslate nohighlight">\(g\)</span> term that we need for the Fisher matrix and <span class="math notranslate nohighlight">\(q_b\)</span> equations (<span class="math notranslate nohighlight">\(\ref{eq:qb}, \ref{eq:fisher}\)</span>), and <span class="math notranslate nohighlight">\(wls\)</span>, the cross spectra of the masks. Within the dictionary are also the components used to make <span class="math notranslate nohighlight">\(g\)</span>.</p>
<p>First, <span class="math notranslate nohighlight">\(wls\)</span> is just <span class="math notranslate nohighlight">\(map2alm\)</span>, and then <span class="math notranslate nohighlight">\(alm2cl\)</span> healpy routines on the masks. If you’re doing a polarized spectrum, the resulting array is 3 x lmax, where the elements are (intensity, pol, intensity x pol). Since our intensity and pol masks are the same, all three elements are the same, and look like this (plotted as <span class="math notranslate nohighlight">\(D_\ell\)</span>):</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">501</span><span class="p">)</span>
<span class="n">lfac</span> <span class="o">=</span> <span class="n">ell</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lfac</span> <span class="o">*</span> <span class="n">w_stuff</span><span class="p">[</span><span class="s1">&#39;wls&#39;</span><span class="p">][</span><span class="s1">&#39;150:150&#39;</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\frac{\ell(\ell+1)}{2\pi}w_\ell$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\ell$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[16]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 0, &#39;$\\ell$&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_34_1.png" src="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_34_1.png" />
</div>
</div>
<p><strong>Note:</strong> most of the quantities in XFaster are ordered dictionaries, where we’ve tried to keep the following tree structure: 1. Spectra (either plain [‘tt’, ‘ee’], etc, or [‘cmb_tt’, ‘cmb_ee’, …, ‘fg_tt’, ‘fg_ee’, …, ‘res_tt’, …] 2. Map/map cross. Crosses are indicated with a colon and are in alphabetical order (so 90 is last): [‘100:100’, ‘100:143’, ‘100:150’, …, ‘90:90’] 3. Stuff. Typically an array, though depending on the data structure, it could be a more deeply nested dictionary.</p>
<p>Now I’ll step through the parts of the code that make up the <span class="math notranslate nohighlight">\(g\)</span> term for one mask:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd"># NBD replace this with generating the map and then doing things with it</span>
<span class="sd">import healpy as hp</span>
<span class="sd">imask = hp.read_map(&quot;../maps_example/masks_rectangle/mask_map_150.fits&quot;,</span>
<span class="sd">                    field=None)</span>
<span class="sd">imask[imask==hp.UNSEEN] = 0</span>
<span class="sd"># this is an array that has one Npix vector for I and one Npix vector for P.</span>
<span class="sd"># Turn it into I, Q, U:</span>
<span class="sd">imask = np.vstack([imask, imask[1]]) # shape (3, npix)</span>
<span class="sd"># *if* we used different masks, we would need to compute all possible products</span>
<span class="sd"># of each of the two masks</span>
<span class="sd">jmask = imask</span>
<span class="sd">mask = np.einsum(&#39;i...,j...-&gt;ij...&#39;, imask, jmask)  # resulting shape (3, 3, npix)</span>
<span class="sd"># counts is:</span>
<span class="sd"># [[nonzero TxT, nonzero TxP, nonzero TxP],</span>
<span class="sd">#  [nonzero TxP, nonzero PxP, nonzero PxP],</span>
<span class="sd">#  [nonzero TxP, nonzero PxP, nonzero PxP]]</span>
<span class="sd">counts = np.count_nonzero(mask, axis=-1).astype(float)</span>
<span class="sd">print(counts)</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[17]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;\n# NBD replace this with generating the map and then doing things with it \nimport healpy as hp\nimask = hp.read_map(&#34;../maps_example/masks_rectangle/mask_map_150.fits&#34;, \n                    field=None)\nimask[imask==hp.UNSEEN] = 0\n# this is an array that has one Npix vector for I and one Npix vector for P. \n# Turn it into I, Q, U:\nimask = np.vstack([imask, imask[1]]) # shape (3, npix)\n# *if* we used different masks, we would need to compute all possible products \n# of each of the two masks\njmask = imask\nmask = np.einsum(\&#39;i...,j...-&gt;ij...\&#39;, imask, jmask)  # resulting shape (3, 3, npix)\n# counts is:\n# [[nonzero TxT, nonzero TxP, nonzero TxP],\n#  [nonzero TxP, nonzero PxP, nonzero PxP],\n#  [nonzero TxP, nonzero PxP, nonzero PxP]]\ncounts = np.count_nonzero(mask, axis=-1).astype(float)\nprint(counts)\n&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd"># fsky is the fraction of pixels that are nonzero, independent</span>
<span class="sd"># of weight</span>
<span class="sd">fsky = counts / X.npix</span>
<span class="sd">print(fsky)</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[18]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;\n# fsky is the fraction of pixels that are nonzero, independent\n# of weight\nfsky = counts / X.npix\nprint(fsky)\n&#39;
</pre></div></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd"># w1, w2, and w4 are the first, second, and fourth moments of the mask.</span>
<span class="sd"># These now take into account the apodization.</span>
<span class="sd">w1 = np.sum(mask, axis=-1) / counts</span>
<span class="sd">w2 = np.sum(mask ** 2, axis=-1) / counts</span>
<span class="sd">w4 = np.sum(mask ** 4, axis=-1) / counts</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[19]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;\n# w1, w2, and w4 are the first, second, and fourth moments of the mask. \n# These now take into account the apodization.\nw1 = np.sum(mask, axis=-1) / counts\nw2 = np.sum(mask ** 2, axis=-1) / counts\nw4 = np.sum(mask ** 4, axis=-1) / counts\n&#39;
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[20]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#print(w1)</span>
<span class="c1">#print(w2)</span>
<span class="c1">#print(w4)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">fsky_eff = fsky * w2 ** 2 / w4 * (1.0 + 4.0 * fsky)</span>
<span class="sd">print(fsky_eff)</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[21]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;\nfsky_eff = fsky * w2 ** 2 / w4 * (1.0 + 4.0 * fsky)\nprint(fsky_eff)\n&#39;
</pre></div></div>
</div>
<p>If we were using a different mask for the two maps that went into computing <code class="docutils literal notranslate"><span class="pre">fsky_eff</span></code>, it would not be diagonal. Because we symmetrize all cross spectra, we want to compute a symmetrized quantity here as well.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">fsky_eff = (fsky_eff + fsky_eff.T) / 2.0</span>
<span class="sd">print(fsky_eff)</span>
<span class="sd">&quot;&quot;&quot;</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[22]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&#39;\nfsky_eff = (fsky_eff + fsky_eff.T) / 2.0\nprint(fsky_eff)\n&#39;
</pre></div></div>
</div>
<p>The <span class="math notranslate nohighlight">\(g\)</span> term in equations <span class="math">\ref{eq:qb}</span> and <span class="math">\ref{eq:fisher}</span> accounts for loss of modes due to the cut sky. It affects the error bars that are computed from the inverse of Equation <span class="math">\ref{eq:fisher}</span> (smaller mask means more variance), but leaves the <span class="math notranslate nohighlight">\(q_b\)</span>’s unbiased. As written, the <span class="math notranslate nohighlight">\(\mathbf{g}\)</span> matrices contain each of the elements in <code class="docutils literal notranslate"><span class="pre">fsky_eff</span></code> along the diagonal. However, to simplify the array mathematics in the code, we
represent the matrix as a dictionary that is effectively the unique elements of <span class="math notranslate nohighlight">\(\mathbf{g}\mathbf{g^T}\)</span>:</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[23]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">X</span><span class="o">.</span><span class="n">gmat</span><span class="p">[</span><span class="s1">&#39;150:150&#39;</span><span class="p">])</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
OrderedDict([(&#39;tt&#39;, 0.05758455584550069), (&#39;ee&#39;, 0.05758455584550069), (&#39;bb&#39;, 0.05758455584550069), (&#39;te&#39;, 0.05758455584550069), (&#39;eb&#39;, 0.05758455584550069), (&#39;tb&#39;, 0.05758455584550069)])
</pre></div></div>
</div>
</div>
<div class="section" id="get_kernels">
<h3>get_kernels<a class="headerlink" href="#get_kernels" title="Permalink to this headline">¶</a></h3>
<p>The next step is to compute the kernels for each mask auto and cross spectrum. In the MASTER formalism, the kernel couples modes to each other on the sky due to the finite dimensions of the mask that is applied to each map that goes into computing a cross spectrum. That is to say, the measured power at a particular <span class="math notranslate nohighlight">\(\ell\)</span> is a weighted average over several other neighboring modes <span class="math notranslate nohighlight">\(\ell^\prime\)</span>, and <span class="math notranslate nohighlight">\(K_{\ell\ell^\prime}\)</span> is the matrix that applies this weighting.</p>
<p>The kernels are computed from the power spectrum of the mask, which we’ll call <span class="math notranslate nohighlight">\(\mathcal{W}_\ell\)</span> (stored as <code class="docutils literal notranslate"><span class="pre">wls</span></code> above), and we compute separate kernels for each of the power spectra, and for each unique pair of maps <code class="docutils literal notranslate"><span class="pre">i</span></code> and <code class="docutils literal notranslate"><span class="pre">j</span></code>.</p>
<p>The set of kernels are:</p>
<p><span class="math">\begin{equation}
\begin{aligned}
K^{ij}_{\ell\ell^\prime} &= \frac{2 \ell^\prime + 1}{4 \pi} \sum_L (2 L + 1) \mathcal{W}^{TT,ij}_L
\begin{pmatrix}
\ell & \ell^\prime & L \\
0 & 0 & 0
\end{pmatrix}^2 \\
_\pm K^{ij}_{\ell\ell^\prime} &= \frac{2 \ell^\prime + 1}{4 \pi} \sum_L \frac{1}{2}(2 L + 1) \mathcal{W}^{PP,ij}_L
\begin{pmatrix}
\ell & \ell^\prime & L \\
2 & -2 & 0
\end{pmatrix}^2 \cdot \frac{1}{2} \left(1 \pm (-1)^{\ell + \ell^\prime + L}\right) \\
_\times K^{ij}_{\ell\ell^\prime} &= \frac{2 \ell^\prime + 1}{4 \pi} \sum_L (2 L + 1) \mathcal{W}^{TP,ij}_L
\begin{pmatrix}
\ell & \ell^\prime & L \\
2 & -2 & 0
\end{pmatrix} \begin{pmatrix}
\ell & \ell^\prime & L \\
0 & 0 & 0
\end{pmatrix}
\end{aligned}
\label{eq:kernels}
\end{equation}</span></p>
<p>The <span class="math notranslate nohighlight">\(\pm\)</span> kernels are used to compute <span class="math notranslate nohighlight">\(EE\)</span>, <span class="math notranslate nohighlight">\(BB\)</span> and <span class="math notranslate nohighlight">\(EB\)</span> power spectrum terms, with the <span class="math notranslate nohighlight">\(-\)</span> term in particular used to account for mixing between <span class="math notranslate nohighlight">\(E\)</span> and <span class="math notranslate nohighlight">\(B\)</span> due to the mask. The <span class="math notranslate nohighlight">\(\times\)</span> kernel is used to compute the <span class="math notranslate nohighlight">\(TE\)</span> and <span class="math notranslate nohighlight">\(TB\)</span> spectra.</p>
<p>Let’s plot some of these up. Because we are using the same mask for all maps, the kernels for each <span class="math notranslate nohighlight">\(ij\)</span> pair will look identical.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[24]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">k</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">get_kernels</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">12</span><span class="p">,</span><span class="mf">5.5</span><span class="p">))</span>
<span class="n">m</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="s1">&#39;kern&#39;</span><span class="p">][</span><span class="s1">&#39;150:150&#39;</span><span class="p">],</span> <span class="n">norm</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmax</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;kern&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$\ell$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="s1">&#39;pkern&#39;</span><span class="p">][</span><span class="s1">&#39;150:150&#39;</span><span class="p">],</span> <span class="n">norm</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmax</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;pkern&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="s1">&#39;mkern&#39;</span><span class="p">][</span><span class="s1">&#39;150:150&#39;</span><span class="p">],</span> <span class="n">norm</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmax</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;mkern&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$\ell$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$\ell^\prime$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">k</span><span class="p">[</span><span class="s1">&#39;xkern&#39;</span><span class="p">][</span><span class="s1">&#39;150:150&#39;</span><span class="p">]),</span> <span class="n">norm</span><span class="o">=</span><span class="n">colors</span><span class="o">.</span><span class="n">LogNorm</span><span class="p">(</span><span class="n">vmax</span><span class="o">=</span><span class="mf">0.01</span><span class="p">,</span> <span class="n">vmin</span><span class="o">=</span><span class="mf">1e-10</span><span class="p">))</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;xkern&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$\ell^\prime$&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">m</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">());</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[25]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.colorbar.Colorbar at 0x7f7a11373220&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_49_1.png" src="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_49_1.png" />
</div>
</div>
<p>Note that the shorter dimension (<span class="math notranslate nohighlight">\(\ell\)</span>) of each kernel goes up to <span class="math notranslate nohighlight">\(\ell_{max}\)</span>, and the longer dimension (<span class="math notranslate nohighlight">\(\ell^\prime\)</span>) extends to <span class="math notranslate nohighlight">\(2 \ell_{max} + 1\)</span>. The kernels are apodized, so that for any row <span class="math notranslate nohighlight">\(\ell\)</span>, the kernels are zero for values <span class="math notranslate nohighlight">\(\ell^\prime &gt; \ell + \ell_{max}\)</span>. The longer dimension is summed over in computing the <span class="math notranslate nohighlight">\(\tilde{\mathcal{C}}_{b\ell}\)</span> terms.</p>
</div>
<div class="section" id="get_masked_sims">
<h3>get_masked_sims<a class="headerlink" href="#get_masked_sims" title="Permalink to this headline">¶</a></h3>
<p>Now we want to get the ensemble average of all of our signal simulations, which we’re going to use to calculate the filter transfer function and also to build the CMB signal model we are comparing our data to. The same function, <code class="docutils literal notranslate"><span class="pre">get_masked_sims</span></code> computes the <span class="math notranslate nohighlight">\(\tilde{\mathcal{C}}_\ell\)</span>s for signal and noise. To start with, we just want the signal ensemble, so get_masked_sims is called as such:</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[26]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">s</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">get_masked_sims</span><span class="p">(</span><span class="n">transfer</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">do_noise</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>This function is doing a very simple thing. For each pair of maps of a given sim index, it 1. Applies the mask. 2. Transforms the maps into <span class="math notranslate nohighlight">\(a_{\ell m}\)</span>s using the healpy routine <code class="docutils literal notranslate"><span class="pre">map2alm</span></code>. 3. Transforms those into <span class="math notranslate nohighlight">\(\tilde{\mathcal{C}}_\ell\)</span>s for that pair using the healpy routine <code class="docutils literal notranslate"><span class="pre">alm2cl</span></code>. 4. Adds the <span class="math notranslate nohighlight">\(\tilde{\mathcal{C}}_\ell\)</span>s to a running average for that particular map cross and spectrum.</p>
<p>It only does <code class="docutils literal notranslate"><span class="pre">map2alm</span></code> once per map and caches the result for use in other cross spectra since this is the slowest step in the function.</p>
<p>These spectra have all the effects of the masking, filtering, and beam included. Let’s compare a couple of them to get a sense for what they look like.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lfac</span> <span class="o">*</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;cls_signal&#39;</span><span class="p">][</span><span class="s1">&#39;tt&#39;</span><span class="p">][</span><span class="s1">&#39;95:95&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95 auto&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lfac</span> <span class="o">*</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;cls_signal&#39;</span><span class="p">][</span><span class="s1">&#39;tt&#39;</span><span class="p">][</span><span class="s1">&#39;150:150&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;150 auto&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lfac</span> <span class="o">*</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;cls_signal&#39;</span><span class="p">][</span><span class="s1">&#39;tt&#39;</span><span class="p">][</span><span class="s1">&#39;150:95&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95 x 150&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$D_\ell [\mu \mathrm</span><span class="si">{K}</span><span class="s1">^2]$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\ell$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;TT&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lfac</span> <span class="o">*</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;cls_signal&#39;</span><span class="p">][</span><span class="s1">&#39;ee&#39;</span><span class="p">][</span><span class="s1">&#39;95:95&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95 auto&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lfac</span> <span class="o">*</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;cls_signal&#39;</span><span class="p">][</span><span class="s1">&#39;ee&#39;</span><span class="p">][</span><span class="s1">&#39;150:150&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;150 auto&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lfac</span> <span class="o">*</span> <span class="n">s</span><span class="p">[</span><span class="s1">&#39;cls_signal&#39;</span><span class="p">][</span><span class="s1">&#39;ee&#39;</span><span class="p">][</span><span class="s1">&#39;150:95&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95 x 150&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\ell$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;EE&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;cls_signal&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[27]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 0.98, &#39;cls_signal&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_55_1.png" src="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_55_1.png" />
</div>
</div>
<p>This set of maps uses regular unimap reobserved constrained synfast sims for SPIDER. The Planck signal sims are not reobserved, but are smoothed to a uniform Gaussian with FWHM=15’. <strong>Note:</strong> XFaster is hardcoded to only expect Planck maps in this form. It does not solve for their transfer function (though that might change) and assumes if it is a Planck map, it has had its original beam deconvolved and smoothed with a common 15 arcmin Gaussian. So it’s clear in these plots that the Planck maps
have more power, since they both haven’t had the heavy SPIDER filtering at low ell and the larger SPIDER beams applied at high ell.</p>
<p>The result of <code class="docutils literal notranslate"><span class="pre">get_masked_sims</span></code> is a spectrum per map cross per spectrum type (TT, EE, etc), which will ultimately be used to make up the <span class="math notranslate nohighlight">\(\tilde{\mathbf{D}}_\ell^{sig}\)</span> matrix that we’ll use for computing the transfer function in <code class="docutils literal notranslate"><span class="pre">get_transfer</span></code> below.</p>
</div>
<div class="section" id="get_beams">
<h3>get_beams<a class="headerlink" href="#get_beams" title="Permalink to this headline">¶</a></h3>
<p>The next component we need for our equations is the beam window function, <span class="math notranslate nohighlight">\(B_\ell\)</span>. XFaster does not solve for this– you have to tell it what it is. For SPIDER, we use the <code class="docutils literal notranslate"><span class="pre">beam20</span></code> product, and for Planck, we’ve smoothed each map to a common 15 arcmin Gaussian (which included deconvolving the original Planck beam for each map).</p>
<p>In <code class="docutils literal notranslate"><span class="pre">xfaster_exec</span></code>, there are optional arguments for this function if you have one ensemble of sims from which to compute the transfer function, and one from which to get the final shape spectrum expected. We used that in the past since transfer function calculation would go haywire at high ell since the beam had cut off so much power. Now, we just look at low ells, so we don’t bother with this extra set of sims.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[28]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">beams</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">get_beams</span><span class="p">(</span><span class="n">pixwin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>We could have a different beam for intensity and polarization. In practice, we don’t, so each of the spectrum fields for beam is the same. Let’s plot them for each map.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="k">for</span> <span class="n">freq</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">map_tags</span><span class="p">:</span>
    <span class="n">plt</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">beams</span><span class="p">[</span><span class="s1">&#39;tt&#39;</span><span class="p">][</span><span class="n">freq</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">freq</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">plt</span><span class="o">.</span><span class="n">ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$B_\ell$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\ell$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[29]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 0, &#39;$\\ell$&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_61_1.png" src="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_61_1.png" />
</div>
</div>
</div>
<div class="section" id="get_signal_shape">
<h3>get_signal_shape<a class="headerlink" href="#get_signal_shape" title="Permalink to this headline">¶</a></h3>
<p>Let’s check in on our progress of components we’ve computed. We’re trying to build everything to make up our <span class="math notranslate nohighlight">\(\tilde{\mathcal{C}}^{XY}_{b\ell}\)</span>s, which as a reminder are the following quantity.</p>
<p><span class="math">\begin{equation}
\tilde{\mathcal{C}}^{XY}_{b\ell} = \sum_{\ell^{\prime}} K_{\ell \ell^{\prime}}^{X Y} F_{\ell^{\prime}}^{X Y} B_{\ell^{\prime}}^{2} \mathcal{C}_{\ell^{\prime}}^{X Y} \chi_{b}\left(\ell^{\prime}\right)
\end{equation}</span></p>
<p>We have <span class="math notranslate nohighlight">\(K_{\ell, \ell'}\)</span> and <span class="math notranslate nohighlight">\(B_{\ell}\)</span>. For the transfer function calculation, we’re going to set <span class="math notranslate nohighlight">\(F_\ell\)</span> to 1 so that we measure <span class="math notranslate nohighlight">\(q_b\)</span>s as the deviation from a uniform transfer function for our simulations. Binning, <span class="math notranslate nohighlight">\(\chi_b\)</span> has been chosen. All that’s left is the full sky signal shape, <span class="math notranslate nohighlight">\(\mathcal{C}_{\ell'}^{XY}\)</span>. For calculating the transfer function, this is just the shape spectrum that went into making our simulations. The script we use to make the
XFaster ensembles, <code class="docutils literal notranslate"><span class="pre">spider_tools/analysis/maps/xfaster_maps.py</span></code>, copies the spectrum it used to make the signal sim maps for reobservation into the top level of the signal sim directory. XFaster looks here for that spectrum, or you can explicitly feed the file in as an argument (the file must be an output file of CAMB– XFaster expects that formatting and those units.)</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[30]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">signal_shape</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">get_signal_shape</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>These will look familiar to you. Note that they are as long as the long dimension of the <span class="math notranslate nohighlight">\(K_{\ell\ell'}\)</span>, which is 2*lmax + 1.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[31]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">ell2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">1001</span><span class="p">)</span>
<span class="n">lfac2</span> <span class="o">=</span> <span class="n">ell2</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell2</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="p">(</span><span class="n">s</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">signal_shape</span><span class="o">.</span><span class="n">items</span><span class="p">()):</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lfac2</span> <span class="o">*</span> <span class="n">spec</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">s</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">]:</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$D_\ell [\mu\mathrm</span><span class="si">{K}</span><span class="s1">^2]$&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">3</span><span class="p">,</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]:</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\ell$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_66_0.png" src="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_66_0.png" />
</div>
</div>
</div>
<div class="section" id="get_transfer">
<h3>get_transfer<a class="headerlink" href="#get_transfer" title="Permalink to this headline">¶</a></h3>
<p>We now have everything we need to compute the transfer function, which is computed per map per spectrum per CMB bin. As a refresher, we’re trying to get <span class="math notranslate nohighlight">\(q_b^{transfer}\)</span>, which is the same as our original expression for <span class="math notranslate nohighlight">\(q_b\)</span> in Equation <span class="math">\ref{eq:qb}</span>, except now we set noise=0, transfer function=1, and instead of using data for our observed signal, we use the ensemble average of our signal sims:</p>
<p><span class="math">\begin{equation}
q_{b}^{transfer}=\frac{1}{2} \sum_{b^{\prime}} \mathcal{F}_{b b^{\prime}}^{-1} \sum_{\ell} (2 \ell+1) \operatorname{Tr}\left[ \left(\tilde{\mathbf{D}}_{\ell}^{-1} \frac{\partial \tilde{\mathbf{S}}_{\ell}}{\partial q_{b^{\prime}}} \tilde{\mathbf{D}}_{\ell}^{-1}\right)\mathbf{g}\tilde{\mathbf{D}}_{\ell}^{signal}\mathbf{g}^T\right]
\label{eq:qb_transfer}
\end{equation}</span></p>
<p>The expression for the Fisher matrix does not change, other than the fact that its constituents are the same as detailed above for the transfer function.</p>
<p><span class="math notranslate nohighlight">\(\frac{\partial \tilde{\mathbf{S}}_{\ell}}{\partial q_{b^{\prime}}}\)</span> is what’s detailed in Equation <span class="math notranslate nohighlight">\(\ref{eq:dsdqb}\)</span>. For the transfer function, since we set noise to be zero, <span class="math notranslate nohighlight">\(\tilde{\mathbf{D}}_\ell\)</span> is equivalent to <span class="math notranslate nohighlight">\(\tilde{\mathbf{S}}_\ell\)</span> in Equation <span class="math">\ref{eq:qb_transfer}</span>.</p>
<p>Within the code, <code class="docutils literal notranslate"><span class="pre">get_transfer</span></code> basically has two steps within the function itself, which it performs per map. 1. Load up the <span class="math notranslate nohighlight">\(\tilde{\mathcal{C}}_{b\ell}\)</span>:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">cbl</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">bin_cl_template</span><span class="p">(</span><span class="n">cls_shape_trf</span><span class="p">,</span> <span class="n">m0</span><span class="p">,</span> <span class="n">transfer_run</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
<p><code class="docutils literal notranslate"><span class="pre">cls_shape_trf</span></code> is signal_shape that we calculated earlier, <code class="docutils literal notranslate"><span class="pre">m0</span></code> is the map, which is used to select the beam and kernel, and <code class="docutils literal notranslate"><span class="pre">transfer_run=True</span></code> sets the <span class="math notranslate nohighlight">\(F_\ell\)</span> term to 1. 2. Run <code class="docutils literal notranslate"><span class="pre">fisher_iterate</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">ret</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fisher_iterate</span><span class="p">(</span><span class="n">cbl</span><span class="p">,</span> <span class="n">cls_shape_trf</span><span class="p">,</span> <span class="n">m0</span><span class="p">,</span> <span class="n">transfer_run</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                          <span class="n">iter_max</span><span class="o">=</span><span class="n">iter_max</span><span class="p">,</span> <span class="n">converge_criteria</span><span class="o">=</span><span class="n">converge_criteria</span><span class="p">,</span>
                          <span class="n">save_iters</span><span class="o">=</span><span class="n">save_iters</span><span class="p">,</span> <span class="n">cond_noise</span><span class="o">=</span><span class="n">cond_noise</span><span class="p">,</span>
                          <span class="n">tophat_bins</span><span class="o">=</span><span class="n">tophat_bins</span><span class="p">)</span>
</pre></div>
</div>
<p>We’ll talk more in the <code class="docutils literal notranslate"><span class="pre">get_bandpowers</span></code> section about the details that happen from here, but broadly, XFaster takes all the inputs we’ve calculated and a starting <span class="math notranslate nohighlight">\(q_b\)</span> guess (1 for all bins), computes the Fisher matrix, plugs that into the <span class="math notranslate nohighlight">\(q_b\)</span> equation to get a new <span class="math notranslate nohighlight">\(q_b\)</span>, and repeats. Once the maximum of |(qb_new-qb)/qb| &lt; converge_criteria, it stops iterating and saves the result.</p>
<p>One additional check that <code class="docutils literal notranslate"><span class="pre">get_transfer</span></code> does is to look for transfer function values that are negative. If it finds any, it changes that bin value to the average of the orignal value and the next bin’s value. This typically happens due to poor choices of binning or too small a number of signal simulations.</p>
<p>Also, Only TT, EE, BB, and TE transfer functions are calculated. EB and TB are computed as</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">qb</span><span class="p">[</span><span class="s1">&#39;cmb_eb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">qb</span><span class="p">[</span><span class="s1">&#39;cmb_ee&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">qb</span><span class="p">[</span><span class="s1">&#39;cmb_bb&#39;</span><span class="p">]))</span>
<span class="n">qb</span><span class="p">[</span><span class="s1">&#39;cmb_tb&#39;</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">qb</span><span class="p">[</span><span class="s1">&#39;cmb_tt&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">qb</span><span class="p">[</span><span class="s1">&#39;cmb_bb&#39;</span><span class="p">]))</span>
</pre></div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[32]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="nb">print</span><span class="p">(</span><span class="n">signal_shape</span><span class="o">.</span><span class="n">keys</span><span class="p">())</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
odict_keys([&#39;cmb_tt&#39;, &#39;cmb_ee&#39;, &#39;cmb_bb&#39;, &#39;cmb_te&#39;, &#39;cmb_eb&#39;, &#39;cmb_tb&#39;])
</pre></div></div>
</div>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[33]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">transfer</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">get_transfer</span><span class="p">(</span><span class="n">signal_shape</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Let’s look at a couple transfer functions.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">plot_inds</span> <span class="o">=</span> <span class="p">{</span><span class="s1">&#39;95&#39;</span><span class="p">:</span> <span class="mi">0</span><span class="p">,</span> <span class="s1">&#39;150&#39;</span><span class="p">:</span> <span class="mi">1</span><span class="p">}</span>
<span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="n">transfer</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
    <span class="k">for</span> <span class="n">m</span><span class="p">,</span> <span class="n">fl</span> <span class="ow">in</span> <span class="n">spec</span><span class="o">.</span><span class="n">items</span><span class="p">():</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">plot_inds</span><span class="p">[</span><span class="n">m</span><span class="p">]]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fl</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">s</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s1">&#39;_&#39;</span><span class="p">)[</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
        <span class="k">if</span> <span class="s1">&#39;tt&#39;</span> <span class="ow">in</span> <span class="n">s</span><span class="p">:</span>
            <span class="n">ax</span><span class="p">[</span><span class="n">plot_inds</span><span class="p">[</span><span class="n">m</span><span class="p">]]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">m</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;bin&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
    <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$F_\ell$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[34]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.legend.Legend at 0x7f79fafa8a00&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_72_1.png" src="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_72_1.png" />
</div>
</div>
</div>
<div class="section" id="get_bin_def-(round-2)">
<h3>get_bin_def (round 2)<a class="headerlink" href="#get_bin_def-(round-2)" title="Permalink to this headline">¶</a></h3>
<p>Up to this point, we’ve been working towards getting the transfer function. Now, we want to set things up for solving for CMB bandpowers, and optionally foreground and/or noise residual bandpowers. We start by adding information about the binning we want for those terms to the <code class="docutils literal notranslate"><span class="pre">bin_def</span></code> dictionary.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[35]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">bin_def</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">get_bin_def</span><span class="p">(</span><span class="n">bin_width</span><span class="o">=</span><span class="mi">25</span><span class="p">,</span> <span class="n">lmin</span><span class="o">=</span><span class="mi">2</span><span class="p">,</span> <span class="n">tbeb</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                        <span class="n">foreground_fit</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span>
                        <span class="n">residual_fit</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">res_specs</span><span class="o">=</span><span class="p">[</span><span class="s1">&#39;eebb&#39;</span><span class="p">],</span>
                        <span class="n">bin_width_res</span><span class="o">=</span><span class="mi">100</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">bin_def</span><span class="o">.</span><span class="n">keys</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[36]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
odict_keys([&#39;cmb_tt&#39;, &#39;cmb_ee&#39;, &#39;cmb_bb&#39;, &#39;cmb_te&#39;, &#39;cmb_eb&#39;, &#39;cmb_tb&#39;, &#39;res_eebb_150&#39;, &#39;res_eebb_95&#39;])
</pre></div></div>
</div>
<p>So now we’ve set up everything we’re going to solve for. Note that the residuals have a couple of unique features. Since we set <code class="docutils literal notranslate"><span class="pre">res_specs=['eebb']</span></code>, XFaster wills solve for a single amplitude for the EE and BB noise residuals. We could have instead set it to <code class="docutils literal notranslate"><span class="pre">['ee',</span> <span class="pre">'bb']</span></code> or <code class="docutils literal notranslate"><span class="pre">['tt',</span> <span class="pre">'ee',</span> <span class="pre">'bb']</span></code>. The default at the moment is to solve for EE and BB together. Also note that noise residuals are fit per map, and that is to that map’s auto-spectrum. We’ll look more at that in the
<code class="docutils literal notranslate"><span class="pre">get_bandpowers</span></code> section.</p>
<p>It’s straightforward here to see how many parameters (<span class="math notranslate nohighlight">\(q_b\)</span>s) XFaster will be solving for– just the total number of bins in bin_def: 120 for CMB, and 10 for noise residuals = 130.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">xfaster</span> <span class="kn">import</span> <span class="n">parse_tools</span> <span class="k">as</span> <span class="n">pt</span>
<span class="n">pt</span><span class="o">.</span><span class="n">dict_to_arr</span><span class="p">(</span><span class="n">bin_def</span><span class="p">)</span><span class="o">.</span><span class="n">shape</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[37]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
(130, 2)
</pre></div></div>
</div>
</div>
<div class="section" id="get_masked_xcorr">
<h3>get_masked_xcorr<a class="headerlink" href="#get_masked_xcorr" title="Permalink to this headline">¶</a></h3>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[38]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">cls_data</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">get_masked_data</span><span class="p">()</span>
</pre></div>
</div>
</div>
<p>This is straightforward. It’s using the healpy routines <code class="docutils literal notranslate"><span class="pre">map2alm</span></code> and <code class="docutils literal notranslate"><span class="pre">alm2cls</span></code> to get all the auto and cross spectra of the data maps. These are all built into the matrix <span class="math notranslate nohighlight">\(\tilde{\mathbf{D}}_\ell^{obs}\)</span> in Equation <span class="math">\ref{eq:qb}</span>. Let’s look at a couple!</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lfac</span> <span class="o">*</span> <span class="n">cls_data</span><span class="p">[</span><span class="s1">&#39;cls_data&#39;</span><span class="p">][</span><span class="s1">&#39;tt&#39;</span><span class="p">][</span><span class="s1">&#39;95:95&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95 auto&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lfac</span> <span class="o">*</span> <span class="n">cls_data</span><span class="p">[</span><span class="s1">&#39;cls_data&#39;</span><span class="p">][</span><span class="s1">&#39;tt&#39;</span><span class="p">][</span><span class="s1">&#39;150:150&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;150 auto&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lfac</span> <span class="o">*</span> <span class="n">cls_data</span><span class="p">[</span><span class="s1">&#39;cls_data&#39;</span><span class="p">][</span><span class="s1">&#39;tt&#39;</span><span class="p">][</span><span class="s1">&#39;150:95&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95 x 150&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$D_\ell [\mu \mathrm</span><span class="si">{K}</span><span class="s1">^2]$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\ell$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;TT&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lfac</span> <span class="o">*</span> <span class="n">cls_data</span><span class="p">[</span><span class="s1">&#39;cls_data&#39;</span><span class="p">][</span><span class="s1">&#39;ee&#39;</span><span class="p">][</span><span class="s1">&#39;95:95&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95 auto&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lfac</span> <span class="o">*</span> <span class="n">cls_data</span><span class="p">[</span><span class="s1">&#39;cls_data&#39;</span><span class="p">][</span><span class="s1">&#39;ee&#39;</span><span class="p">][</span><span class="s1">&#39;150:150&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;150 auto&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lfac</span> <span class="o">*</span> <span class="n">cls_data</span><span class="p">[</span><span class="s1">&#39;cls_data&#39;</span><span class="p">][</span><span class="s1">&#39;ee&#39;</span><span class="p">][</span><span class="s1">&#39;150:95&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95 x 150&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\ell$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;EE&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;cls_data&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[39]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 0.98, &#39;cls_data&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_82_1.png" src="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_82_1.png" />
</div>
</div>
</div>
<div class="section" id="get_masked_sims-(round-2)">
<h3>get_masked_sims (round 2)<a class="headerlink" href="#get_masked_sims-(round-2)" title="Permalink to this headline">¶</a></h3>
<p>Now we do the same thing for all the sims. We’ve already done the signal sims since those were used for the transfer function, so the code sees that they’re on disk and doesn’t recompute them. It doesn’t find the noise sims, so it computes those for each sim index for each auto and cross.</p>
<p>There are a few options you can use here. These options do not affect the ensemble average for signal and noise sims that are used to build the equations for <span class="math notranslate nohighlight">\(q_b\)</span> and the Fisher matrix. Instead, they are for use when you don’t want XFaster to compute bandpowers for data, but for simulations instead. If <code class="docutils literal notranslate"><span class="pre">ensemble_mean=True</span></code>, XFaster will replace the observed data matrix, <span class="math notranslate nohighlight">\(\tilde{\mathbf{D}}_\ell^{obs}\)</span>, with the ensemble average of signal plus the ensemble average of the noise
sims. If <code class="docutils literal notranslate"><span class="pre">sim_index</span></code> is not None, it will replace the data matrix with the signal + noise spectra from the sim specified. If <code class="docutils literal notranslate"><span class="pre">sims_add_alms=True</span></code>, it will do that addition in <span class="math notranslate nohighlight">\(a_{\ell m}\)</span>s. If it is False, it will do the addition in <span class="math notranslate nohighlight">\(\tilde{\mathcal{C}}_\ell\)</span>s. The latter would not include signal cross noise; the former would.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[40]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">sims</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">get_masked_sims</span><span class="p">(</span><span class="n">ensemble_mean</span><span class="o">=</span><span class="kc">False</span><span class="p">,</span> <span class="n">sim_index</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">sims_add_alms</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Now we have signal and noise in our sims dictionary. We’ve looked some signal spectra. Let’s look at the same in noise.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lfac</span> <span class="o">*</span> <span class="n">sims</span><span class="p">[</span><span class="s1">&#39;cls_noise&#39;</span><span class="p">][</span><span class="s1">&#39;tt&#39;</span><span class="p">][</span><span class="s1">&#39;95:95&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95 auto&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lfac</span> <span class="o">*</span> <span class="n">sims</span><span class="p">[</span><span class="s1">&#39;cls_noise&#39;</span><span class="p">][</span><span class="s1">&#39;tt&#39;</span><span class="p">][</span><span class="s1">&#39;150:150&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;150 auto&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lfac</span> <span class="o">*</span> <span class="n">sims</span><span class="p">[</span><span class="s1">&#39;cls_noise&#39;</span><span class="p">][</span><span class="s1">&#39;tt&#39;</span><span class="p">][</span><span class="s1">&#39;150:95&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95 x 150&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$D_\ell [\mu \mathrm</span><span class="si">{K}</span><span class="s1">^2]$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\ell$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;TT&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lfac</span> <span class="o">*</span> <span class="n">sims</span><span class="p">[</span><span class="s1">&#39;cls_noise&#39;</span><span class="p">][</span><span class="s1">&#39;ee&#39;</span><span class="p">][</span><span class="s1">&#39;95:95&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95 auto&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lfac</span> <span class="o">*</span> <span class="n">sims</span><span class="p">[</span><span class="s1">&#39;cls_noise&#39;</span><span class="p">][</span><span class="s1">&#39;ee&#39;</span><span class="p">][</span><span class="s1">&#39;150:150&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;150 auto&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lfac</span> <span class="o">*</span> <span class="n">sims</span><span class="p">[</span><span class="s1">&#39;cls_noise&#39;</span><span class="p">][</span><span class="s1">&#39;ee&#39;</span><span class="p">][</span><span class="s1">&#39;150:95&#39;</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;95 x 150&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\ell$&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;EE&#39;</span><span class="p">)</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;cls_noise&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[41]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 0.98, &#39;cls_noise&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_87_1.png" src="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_87_1.png" />
</div>
</div>
</div>
<div class="section" id="get_beams-(round-2)">
<h3>get_beams (round 2)<a class="headerlink" href="#get_beams-(round-2)" title="Permalink to this headline">¶</a></h3>
<p>There’s now another call to get_beams, which is totally superfluous if you’re using the same signal sims for transfer functions that you are for your signal ensemble average. But, if you wanted to use a narrower beam for the former and a more realistic wider beam for the latter, this is where you’d load up the latter. For our case, we’ll do it just so you can see the log message.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[42]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">b</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">get_beams</span><span class="p">(</span><span class="n">pixwin</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
</pre></div>
</div>
</div>
</div>
<div class="section" id="get_bandpowers">
<h3>get_bandpowers<a class="headerlink" href="#get_bandpowers" title="Permalink to this headline">¶</a></h3>
<p>Now we put it all together! The function <code class="docutils literal notranslate"><span class="pre">get_bandpowers</span></code> works just like <code class="docutils literal notranslate"><span class="pre">get_transfer</span></code>, with the transfer function terms no longer set to unity, and instead constructed from the <span class="math notranslate nohighlight">\(q_b\)</span>’s computed by <code class="docutils literal notranslate"><span class="pre">get_transfer</span></code>.</p>
<div class="section" id="Constructing-the-model-spectrum">
<h4>Constructing the model spectrum<a class="headerlink" href="#Constructing-the-model-spectrum" title="Permalink to this headline">¶</a></h4>
<p>The first step is to construct the <span class="math notranslate nohighlight">\(\tilde{\mathcal{C}}_{b\ell}\)</span>’s including all of the additional components in the model. There are now two new pieces here: a foreground component that varies with frequency, and includes a linearized component for its spectral index, and so-called “noise residuals” that account for the inaccuracy of our noise model in the auto-spectra.</p>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[43]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">cbl</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">bin_cl_template</span><span class="p">(</span><span class="n">signal_shape</span><span class="p">,</span> <span class="n">map_tag</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">transfer_run</span><span class="o">=</span><span class="kc">False</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>Let’s plot up each set of components individually. First, the CMB component, which should look familiar. Each color represents the <span class="math notranslate nohighlight">\(\tilde{\mathcal{C}}_{b\ell}\)</span> for a single bin. The black lines show the total shape of each component in <span class="math notranslate nohighlight">\(\ell\)</span>, assuming the <span class="math notranslate nohighlight">\(q_b\)</span> applied to each bin is set to 1. This is what we call the <em>model spectrum</em> that we are fitting to. Notice that the EE and BB mixing terms have very broad bins and are very low amplitude. This is due to the shape of the
<span class="math notranslate nohighlight">\(_{-}K_{\ell\ell^\prime}\)</span> kernel as a function of <span class="math notranslate nohighlight">\(\ell\)</span>. These shapes will look different for each map cross, due to differences in each transfer function and beam.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[44]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">14</span><span class="p">,</span><span class="mi">7</span><span class="p">),</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">ell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">501</span><span class="p">)</span>
<span class="n">ellfac</span> <span class="o">=</span> <span class="n">ell</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">comps</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;cmb_tt&#39;</span><span class="p">,</span> <span class="s1">&#39;cmb_te&#39;</span><span class="p">,</span> <span class="s1">&#39;cmb_ee&#39;</span><span class="p">,</span> <span class="s1">&#39;cmb_ee_mix&#39;</span><span class="p">,</span> <span class="s1">&#39;cmb_eb&#39;</span><span class="p">,</span> <span class="s1">&#39;cmb_tb&#39;</span><span class="p">,</span> <span class="s1">&#39;cmb_bb&#39;</span><span class="p">,</span> <span class="s1">&#39;cmb_bb_mix&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="n">comps</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;150 x 150 </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp</span><span class="p">))</span>
    <span class="n">cbl1</span> <span class="o">=</span> <span class="n">cbl</span><span class="p">[</span><span class="n">comp</span><span class="p">][</span><span class="s1">&#39;150:150&#39;</span><span class="p">]</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">cbl1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">ellfac</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cbl1</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">ellfac</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">4</span><span class="p">]:</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$D_\ell$&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">8</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$\ell$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_95_0.png" src="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_95_0.png" />
</div>
</div>
<p>The next model component that we include accounts for residual noise in the auto-spectra. These <span class="math notranslate nohighlight">\(\tilde{\mathcal{C}}_{b\ell}\)</span> terms do not include any transfer functions, beams or mode mixing kernels. They are derived from the <em>simulated</em> noise spectra <span class="math notranslate nohighlight">\(\tilde{N}_\ell\)</span> that are subtracted from the <em>measured</em> data as in equation <span class="math">\ref{eq:qb}</span>. These terms act as corrections to the noise model by adjusting the auto-spectrum noise components to agree with the cross terms.</p>
<p>We fit only for the EE and BB components, and we do so in a simultaneous way. That is, each <span class="math notranslate nohighlight">\(q_b^{res,EEBB}\)</span> applies to both <span class="math notranslate nohighlight">\(\tilde{\mathcal{C}}_{b\ell}^{EE}\)</span> and <span class="math notranslate nohighlight">\(\tilde{\mathcal{C}}_{b\ell}^{BB}\)</span> here. The TT spectrum is very much signal dominated, so we don’t bother correcting TT auto spectra this way.</p>
<p>The residual signal model is thus:</p>
<p><span class="math">\begin{equation}
\tilde{\mathbf{S}}_\ell^{res,ij} = \delta_{ij}\,
\begin{bmatrix}
0 & 0 & 0 \\
0 & \sum_b q_b^{EEBB} \tilde{\mathcal{C}}_{b\ell}^{EE} & 0 \\
0 & 0 & \sum_b q_b^{EEBB} \tilde{\mathcal{C}}_{b\ell}^{BB} \\
\end{bmatrix}_{\,res,ij}
\label{eq:signal_res}
\end{equation}</span></p>
<p>and the derivatives are</p>
<p><span class="math">\begin{equation}
\frac{\partial \tilde{\mathbf{S}}_\ell}{\partial q_b^{res,ij,EEBB}} = \delta_{ij}\,
\begin{bmatrix}
0 & 0 & 0 \\
0 & \tilde{\mathcal{C}}_{b\ell}^{EE} & 0 \\
0 & 0 & \tilde{\mathcal{C}}_{b\ell}^{BB} \\
\end{bmatrix}_{\,res,ij}
\label{eq:signal_res_deriv}
\end{equation}</span></p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[45]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">sharex</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">7</span><span class="p">,</span><span class="mf">3.5</span><span class="p">))</span>
<span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">ell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">501</span><span class="p">)</span>
<span class="n">ellfac</span> <span class="o">=</span> <span class="n">ell</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">comps</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;res_ee&#39;</span><span class="p">,</span> <span class="s1">&#39;res_bb&#39;</span><span class="p">]</span>
<span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">comp</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="n">comps</span><span class="p">):</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;150 x 150 </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp</span><span class="p">))</span>
    <span class="n">cbl1</span> <span class="o">=</span> <span class="n">cbl</span><span class="p">[</span><span class="n">comp</span><span class="p">][</span><span class="s1">&#39;150:150&#39;</span><span class="p">]</span>
    <span class="n">d</span> <span class="o">=</span> <span class="n">cbl1</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">ellfac</span><span class="p">,</span> <span class="s1">&#39;k&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">cbl1</span><span class="p">:</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">d</span> <span class="o">*</span> <span class="n">ellfac</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$D_\ell$&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$\ell$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_97_0.png" src="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_97_0.png" />
</div>
</div>
<p>Next we add our actual noise simulations to the model. The residual noise terms discussed above are designed to account for inaccuracies in this model. We assume that the cross terms are accurate, and only correct the auto spectra for EE and BB in this way.</p>
<p>We often find that the fisher iterations have trouble converging due to degeneracies in the lower bins, so we also include a term we call “conditioning noise” along the TT/EE/BB diagonals as well. The conditioning noise is modeled as:</p>
<p><span class="math">\begin{equation}
\tilde{\mathbf{S}}_\ell^{cond,ij,XY} = \delta_{ij} c_{XY} \frac{\ell + 1}{\ell^2}
\end{equation}</span></p>
<p>where <span class="math notranslate nohighlight">\(c_{EE} = c_{BB}\)</span> is parameterized by the <code class="docutils literal notranslate"><span class="pre">cond_noise</span></code> option, typically a small number O(0.01) or less, <span class="math notranslate nohighlight">\(c_{TT} = 100 c_{EE}\)</span> and all others are 0.</p>
<p>To plot up both of these model components, along with all of the terms discussed above, let’s call an internal function that computes the model spectrum for us, given the <span class="math notranslate nohighlight">\(\tilde{\mathcal{C}}_{b\ell}\)</span> terms and some model parameters <span class="math notranslate nohighlight">\(q_b\)</span>.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[46]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">collections</span> <span class="kn">import</span> <span class="n">OrderedDict</span>
<span class="c1"># construct a dummy qb array to compute input model</span>
<span class="n">qb</span> <span class="o">=</span> <span class="n">OrderedDict</span><span class="p">([(</span><span class="n">k</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">v</span><span class="p">)))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span> <span class="n">v</span> <span class="ow">in</span> <span class="n">X</span><span class="o">.</span><span class="n">bin_def</span><span class="o">.</span><span class="n">items</span><span class="p">()])</span>
<span class="n">cls_model</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">get_model_spectra</span><span class="p">(</span><span class="n">qb</span><span class="p">,</span> <span class="n">cbl</span><span class="p">,</span> <span class="n">delta</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span> <span class="n">cls_noise</span><span class="o">=</span><span class="n">X</span><span class="o">.</span><span class="n">cls_noise</span><span class="p">,</span> <span class="n">cond_noise</span><span class="o">=</span><span class="mf">0.03</span><span class="p">)</span>

<span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">ell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">501</span><span class="p">)</span>
<span class="n">ellfac</span> <span class="o">=</span> <span class="n">ell</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">xname</span> <span class="o">=</span> <span class="s1">&#39;150:150&#39;</span>
<span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cmb&#39;</span><span class="p">,</span> <span class="s1">&#39;noise&#39;</span><span class="p">,</span> <span class="s1">&#39;res&#39;</span><span class="p">,</span> <span class="s1">&#39;cond&#39;</span><span class="p">,</span> <span class="s1">&#39;total&#39;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;tt&#39;</span><span class="p">,</span> <span class="s1">&#39;ee&#39;</span><span class="p">,</span> <span class="s1">&#39;bb&#39;</span><span class="p">,</span> <span class="s1">&#39;te&#39;</span><span class="p">,</span> <span class="s1">&#39;eb&#39;</span><span class="p">,</span> <span class="s1">&#39;tb&#39;</span><span class="p">]):</span>
        <span class="n">stag</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cls_model</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">comp</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">comp</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;res&#39;</span><span class="p">,</span> <span class="s1">&#39;total&#39;</span><span class="p">]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ellfac</span> <span class="o">*</span> <span class="n">cls_model</span><span class="p">[</span><span class="n">stag</span><span class="p">][</span><span class="n">xname</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">comp</span><span class="p">,</span> <span class="n">linestyle</span><span class="o">=</span><span class="s1">&#39;--&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ellfac</span> <span class="o">*</span> <span class="n">cls_model</span><span class="p">[</span><span class="n">stag</span><span class="p">][</span><span class="n">xname</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">comp</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;150 x 150 </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec</span><span class="p">))</span>
        <span class="k">if</span> <span class="n">spec</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;ee&#39;</span><span class="p">,</span> <span class="s1">&#39;bb&#39;</span><span class="p">]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mf">0.01</span><span class="p">,</span> <span class="mf">0.175</span><span class="p">)</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">]:</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$D_\ell$&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$\ell$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_99_0.png" src="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_99_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[47]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">fig</span><span class="p">,</span> <span class="n">axs</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">11</span><span class="p">,</span><span class="mi">7</span><span class="p">))</span>
<span class="n">axs</span> <span class="o">=</span> <span class="n">axs</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span>
<span class="n">ell</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">501</span><span class="p">)</span>
<span class="n">ellfac</span> <span class="o">=</span> <span class="n">ell</span> <span class="o">*</span> <span class="p">(</span><span class="n">ell</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span> <span class="o">/</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span>
<span class="n">xname</span> <span class="o">=</span> <span class="s1">&#39;150:95&#39;</span>
<span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cmb&#39;</span><span class="p">,</span> <span class="s1">&#39;noise&#39;</span><span class="p">,</span> <span class="s1">&#39;res&#39;</span><span class="p">,</span> <span class="s1">&#39;cond&#39;</span><span class="p">,</span> <span class="s1">&#39;total&#39;</span><span class="p">]:</span>
    <span class="k">for</span> <span class="n">ax</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">zip</span><span class="p">(</span><span class="n">axs</span><span class="p">,</span> <span class="p">[</span><span class="s1">&#39;tt&#39;</span><span class="p">,</span> <span class="s1">&#39;ee&#39;</span><span class="p">,</span> <span class="s1">&#39;bb&#39;</span><span class="p">,</span> <span class="s1">&#39;te&#39;</span><span class="p">,</span> <span class="s1">&#39;eb&#39;</span><span class="p">,</span> <span class="s1">&#39;tb&#39;</span><span class="p">]):</span>
        <span class="n">stag</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">stag</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cls_model</span> <span class="ow">or</span> <span class="n">xname</span> <span class="ow">not</span> <span class="ow">in</span> <span class="n">cls_model</span><span class="p">[</span><span class="n">stag</span><span class="p">]:</span>
            <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="n">comp</span><span class="p">)</span>
            <span class="k">continue</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">ellfac</span> <span class="o">*</span> <span class="n">cls_model</span><span class="p">[</span><span class="n">stag</span><span class="p">][</span><span class="n">xname</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="n">comp</span><span class="p">)</span>
        <span class="n">ax</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;150 x 90 </span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">spec</span><span class="p">))</span>
<span class="n">axs</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">3</span><span class="p">]:</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;$D_\ell$&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">6</span><span class="p">):</span>
    <span class="n">axs</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;$\ell$&#39;</span><span class="p">)</span>
<span class="n">plt</span><span class="o">.</span><span class="n">tight_layout</span><span class="p">()</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_100_0.png" src="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_100_0.png" />
</div>
</div>
<p>Note that neither conditioning noise nor residual terms are present in the 150x90 spectra.</p>
<p>Note also that the shape of the conditioning noise is counter-intuitive. It should be largest at low ell to improve convergence, but it is not. This seems like a bug.</p>
</div>
<div class="section" id="Computing-the-Fisher-matrix">
<h4>Computing the Fisher matrix<a class="headerlink" href="#Computing-the-Fisher-matrix" title="Permalink to this headline">¶</a></h4>
<p>Ok! Now that we have all the pieces in place, all that’s left is to do some matrix math and iterate over equations <span class="math">\ref{eq:qb}</span> and <span class="math">\ref{eq:fisher}</span> until the results converge. The two equations are constructed in the function <code class="docutils literal notranslate"><span class="pre">fisher_calc</span></code>, which is called iteratively by <code class="docutils literal notranslate"><span class="pre">fisher_iterate</span></code> until convergence is reached.</p>
<p>In order to make all the quantities we’ve computed look like matrices, we have two utility functions, <code class="docutils literal notranslate"><span class="pre">dict_to_dmat</span></code> and <code class="docutils literal notranslate"><span class="pre">dict_to_dsdqb_mat</span></code>, that convert the dictionaries <code class="docutils literal notranslate"><span class="pre">Dmat1</span></code> (corresponding to <span class="math notranslate nohighlight">\(\mathbf{D}_\ell\)</span> in the equations) and <code class="docutils literal notranslate"><span class="pre">dSdqb_mat1_freq</span></code> (<span class="math notranslate nohighlight">\(\partial \mathbf{S}_\ell / \partial q_b\)</span>) into matrices.</p>
<p>The <code class="docutils literal notranslate"><span class="pre">Dmat1</span></code> matrix has shape <code class="docutils literal notranslate"><span class="pre">(3</span> <span class="pre">*</span> <span class="pre">num_maps,</span> <span class="pre">3</span> <span class="pre">*</span> <span class="pre">num_maps,</span> <span class="pre">lmax</span> <span class="pre">+</span> <span class="pre">1)</span></code> and contains the <code class="docutils literal notranslate"><span class="pre">total</span></code> model terms for each map cross spectrum, ordered as in equation <span class="math">\ref{eq:dell}</span>. The <code class="docutils literal notranslate"><span class="pre">dSdqb_mat1_freq</span></code> matrix has shape <code class="docutils literal notranslate"><span class="pre">(3</span> <span class="pre">*</span> <span class="pre">num_maps,</span> <span class="pre">3</span> <span class="pre">*</span> <span class="pre">num_maps,</span> <span class="pre">nbins,</span> <span class="pre">lmax</span> <span class="pre">+</span> <span class="pre">1)</span></code> and includes the CMB, residuals and frequency-corrected foreground components for all the crosses. We then compute the quantity</p>
<p><span class="math">\begin{equation}
\mathbf{D}^{-1} \frac{\partial \mathbf{S}}{\partial q_b} \mathbf{D}^{-1}
\end{equation}</span></p>
<p>using the following code:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Dmat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">inv</span><span class="p">(</span><span class="n">Dmat1</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">))</span><span class="o">.</span><span class="n">swapaxes</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
<span class="n">eye</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">gmat</span><span class="p">))</span>
<span class="n">mat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ij...,jk...-&gt;ik...&#39;</span><span class="p">,</span> <span class="n">eye</span><span class="p">,</span> <span class="n">Dmat1</span><span class="p">)</span>
<span class="n">mat2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;klm...,ln...-&gt;knm...&#39;</span><span class="p">,</span> <span class="n">dSdqb_mat1_freq</span><span class="p">,</span> <span class="n">Dmat1</span><span class="p">)</span>
<span class="n">mat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ik...,knm...-&gt;inm...&#39;</span><span class="p">,</span> <span class="n">mat1</span><span class="p">,</span> <span class="n">mat2</span><span class="p">)</span>
</pre></div>
</div>
<p>The first line computes the inverse of <span class="math notranslate nohighlight">\(D\)</span>, ell-by-ell along the first two dimensions. The next two lines are necessary due to some quirk of memory access in python; this is just multiplying the first two dimensions of <code class="docutils literal notranslate"><span class="pre">Dmat1</span></code> by the identity matrix. The last two lines do the matrix multiplication along the first two dimensions of each of the matrices.</p>
<p>Now, we apply the <span class="math notranslate nohighlight">\(\mathbf{g}\)</span> correction factor as in equations <span class="math">\ref{eq:qb}</span> and <span class="math">\ref{eq:fisher}</span>. The following two lines multiply <span class="math notranslate nohighlight">\(\mathbf{gg}^T\)</span> element-by-element along the first two dimensions of <code class="docutils literal notranslate"><span class="pre">Dmat_obs</span></code> and <code class="docutils literal notranslate"><span class="pre">dSdqb_mat1_freq</span></code>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">Dmat_obs_g</span> <span class="o">=</span> <span class="n">gmat</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">Dmat_obs</span>
<span class="n">dSdqb_mat1_g</span> <span class="o">=</span> <span class="n">gmat</span><span class="p">[</span><span class="o">...</span><span class="p">,</span> <span class="kc">None</span><span class="p">,</span> <span class="kc">None</span><span class="p">]</span> <span class="o">*</span> <span class="n">dSdqb_mat1_freq</span>
</pre></div>
</div>
<p>Next we compute the big matrices in equations <span class="math">\ref{eq:qb}</span> and <span class="math">\ref{eq:fisher}</span> and compute their traces in a single step:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">matd</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijk...,ji...-&gt;k...&#39;</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">Dmat_obs_g</span><span class="p">)</span>
<span class="n">mats</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;ijk...,jil...-&gt;kl...&#39;</span><span class="p">,</span> <span class="n">mat</span><span class="p">,</span> <span class="n">dSdqb_mat1_g</span><span class="p">)</span>
</pre></div>
</div>
<p>And finally, we sum over <span class="math notranslate nohighlight">\(\ell\)</span> to compute <span class="math notranslate nohighlight">\(v_b = \sum_b' \mathcal{F}_{bb^\prime}q_{b'}\)</span> and <span class="math notranslate nohighlight">\(\mathcal{F}_{bb^\prime}\)</span>. <span class="math notranslate nohighlight">\(v_b\)</span> now just needs the inverse Fisher matrix applied to it to get <span class="math notranslate nohighlight">\(q_b\)</span>.</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">qb_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">matd</span><span class="p">,</span> <span class="n">ellfac</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
<span class="n">fisher</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">mats</span><span class="p">,</span> <span class="n">ellfac</span><span class="p">)</span> <span class="o">/</span> <span class="mf">2.0</span>
</pre></div>
</div>
</div>
<div class="section" id="Inverting-the-Fisher-matrix">
<h4>Inverting the Fisher matrix<a class="headerlink" href="#Inverting-the-Fisher-matrix" title="Permalink to this headline">¶</a></h4>
<p>Now we take the inverse. The <code class="docutils literal notranslate"><span class="pre">solve</span></code> function in the <code class="docutils literal notranslate"><span class="pre">numpy.linalg</span></code> library does so efficiently:</p>
<div class="highlight-python notranslate"><div class="highlight"><pre><span></span><span class="n">qb_vec</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">fisher</span><span class="p">,</span> <span class="n">qb_vec</span><span class="p">)</span>
<span class="n">inv_fish</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">linalg</span><span class="o">.</span><span class="n">solve</span><span class="p">(</span><span class="n">fisher</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">eye</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">qb_vec</span><span class="p">)))</span>
</pre></div>
</div>
<p>With each iteration, we compare the new <code class="docutils literal notranslate"><span class="pre">qb_vec</span></code> quantity to the previous one, until the maximum fractional change in any element of the array is less than the convergence criterion (0.005 is typical).</p>
</div>
<div class="section" id="Constructing-final-bandpowers">
<h4>Constructing final bandpowers<a class="headerlink" href="#Constructing-final-bandpowers" title="Permalink to this headline">¶</a></h4>
<p>To construct bandpowers, we need to apply the <span class="math notranslate nohighlight">\(q_b\)</span> parameters to the input shape spectra. This is done by integrating over each bin using a weighting scheme. The quantity we want in the end should be in units of <span class="math notranslate nohighlight">\(\mathcal{D}_\ell = \ell (\ell + 1) C_\ell / 2\pi\)</span>, where <span class="math notranslate nohighlight">\(C_\ell\)</span> is the appropriate input shape spectrum. Assuming some weighted integral <span class="math notranslate nohighlight">\(\mathcal{I}_b\)</span> for a given bin, we compute each bandpower as a weighted integral of <span class="math notranslate nohighlight">\(\ell (\ell + 1) C_\ell / 2\pi\)</span>,
scaled by the appropriate <span class="math notranslate nohighlight">\(q_b\)</span>, and normalized by the integral of the weights:</p>
<p><span class="math">\begin{equation}
\mathcal{D}_b = q_b \frac{ \mathcal{I}_b\left[\frac{\ell (\ell + 1)}{2\pi} C_\ell \right] }{ \mathcal{I}_b\left[ 1 \right] }
\end{equation}</span></p>
<p>Similarly, the errors on each bandpower are:</p>
<p><span class="math">\begin{equation}
\Delta\mathcal{D}_b = \sqrt{F^{-1}_{bb}} \frac{ \mathcal{I}_b\left[\frac{\ell (\ell + 1)}{2\pi} C_\ell \right] }{ \mathcal{I}_b\left[ 1 \right] }
\end{equation}</span></p>
<p>To be specific, we define the weighted integral as:</p>
<p><span class="math">\begin{equation}
\mathcal{I}_b\left[f_\ell\right] = \sum_\ell \frac{1}{2} \frac{2\ell + 1}{\ell (\ell + 1)} \chi_b(\ell) \, f_\ell
\end{equation}</span></p>
<p>where <span class="math notranslate nohighlight">\(\chi_b(\ell)\)</span> is a top-hat function with value 1 within the bin and 0 outside of it. This weighting scheme is taken from <a class="reference external" href="https://arxiv.org/pdf/astro-ph/9808264.pdf">Section 4.2 of Bond, Jaffe, and Knox (2000)</a>. With this definition, the bin centers are:</p>
<p><span class="math">\begin{equation}
\ell_b = \frac{ \mathcal{I}_b\left[\frac{\ell (\ell + 1)}{2\pi} C_\ell \, \ell \right] }{ \mathcal{I}_b\left[ \frac{\ell (\ell + 1)}{2\pi} C_\ell \right] }
\end{equation}</span></p>
<p>While this definition of the integral is sufficient, the more accurate calculation constructs <span class="math notranslate nohighlight">\(\chi_b(\ell)\)</span> as a window function that includes beam, transfer function and kernel effects that distribute power as a function of <span class="math notranslate nohighlight">\(\ell\)</span>. This has yet to be implemented.</p>
</div>
</div>
</div>
<div class="section" id="Looking-at-results">
<h2>Looking at results<a class="headerlink" href="#Looking-at-results" title="Permalink to this headline">¶</a></h2>
<div class="nbinput nblast docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[48]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="n">bp</span> <span class="o">=</span> <span class="n">X</span><span class="o">.</span><span class="n">get_bandpowers</span><span class="p">(</span><span class="n">signal_shape</span><span class="p">,</span> <span class="n">converge_criteria</span><span class="o">=</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">iter_max</span><span class="o">=</span><span class="mi">200</span><span class="p">,</span> <span class="n">save_iters</span><span class="o">=</span><span class="kc">True</span><span class="p">,</span>
                      <span class="n">cond_noise</span><span class="o">=</span><span class="mf">0.03</span><span class="p">)</span>
</pre></div>
</div>
</div>
<p>In the plot below, we’ll plot up the maximum fractional change in <span class="math notranslate nohighlight">\(q_b\)</span> with iteration. This information is printed in the logs, but it’s helpful to visualize on a plot. You can see it bounce around early on before settling down and ultimately stopping once it gets to the desginated criterion.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[49]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">import</span> <span class="nn">glob</span>
<span class="n">iters</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="s1">&#39;../outputs_example/95x150/bandpowers_iter*&#39;</span><span class="p">)</span>
<span class="c1">### Figure for seeing how convergence looks in fqb</span>
<span class="n">fig_fqb</span><span class="p">,</span> <span class="n">ax_fqb</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">()</span>
<span class="n">ax_fqb</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mf">0.005</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;convergence criterion&#39;</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;C1&#39;</span><span class="p">)</span>
<span class="n">ax_fqb</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Max fractional change in qb vs iter&#39;</span><span class="p">)</span>
<span class="n">ax_fqb</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="s1">&#39;Maximum absolute fqb&#39;</span><span class="p">)</span>
<span class="n">ax_fqb</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;Iteration&#39;</span><span class="p">)</span>
<span class="n">fqb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">iters</span><span class="p">))</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bp0</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iters</span><span class="p">):</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">xf</span><span class="o">.</span><span class="n">load_and_parse</span><span class="p">(</span><span class="n">bp0</span><span class="p">)</span>
    <span class="n">fqb</span><span class="p">[</span><span class="n">i</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;fqb&#39;</span><span class="p">]))</span>
<span class="n">ax_fqb</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">fqb</span><span class="p">,</span> <span class="n">marker</span><span class="o">=</span><span class="s1">&#39;o&#39;</span><span class="p">)</span>
<span class="n">ax_fqb</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">ax_fqb</span><span class="o">.</span><span class="n">set_yscale</span><span class="p">(</span><span class="s1">&#39;log&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_108_0.png" src="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_108_0.png" />
</div>
</div>
<p>Now let’s see how the total model (summing up the <span class="math notranslate nohighlight">\(q_b\mathcal{C}_{b\ell}\)</span> terms for every component) to see how it converges to fit the data. Within a few iterations, it’s quite close.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">### Figure for looking at how sum(qbCbl) changes with iteration to match data</span>
<span class="n">figtmp</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">tmpplot</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;viridis&#39;</span><span class="p">),</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">iters</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">figtmp</span><span class="p">)</span>
<span class="n">fig_dat</span><span class="p">,</span> <span class="n">ax_dat</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">2</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">ax_dat</span> <span class="o">=</span> <span class="n">ax_dat</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">specs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tt&#39;</span><span class="p">,</span> <span class="s1">&#39;ee&#39;</span><span class="p">,</span> <span class="s1">&#39;bb&#39;</span><span class="p">,</span> <span class="s1">&#39;te&#39;</span><span class="p">,</span> <span class="s1">&#39;tb&#39;</span><span class="p">,</span> <span class="s1">&#39;eb&#39;</span><span class="p">]</span>
<span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">iters</span><span class="p">))</span><span class="o">.</span><span class="n">colors</span>
<span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
    <span class="n">ax_dat</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bp0</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iters</span><span class="p">):</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">xf</span><span class="o">.</span><span class="n">load_and_parse</span><span class="p">(</span><span class="n">bp0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">i</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># data cls don&#39;t change with iter- plot once.</span>
            <span class="n">ax_dat</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;cls_obs&#39;</span><span class="p">][</span><span class="n">spec</span><span class="p">][</span><span class="s1">&#39;150:95&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">lfac</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;data&#39;</span><span class="p">)</span>
        <span class="n">ax_dat</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">b</span><span class="p">[</span><span class="s1">&#39;cls_model&#39;</span><span class="p">][</span><span class="s1">&#39;total_&#39;</span><span class="o">+</span><span class="n">spec</span><span class="p">][</span><span class="s1">&#39;150:95&#39;</span><span class="p">]</span> <span class="o">*</span> <span class="n">lfac</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">])</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">3</span><span class="p">]:</span>
    <span class="n">ax_dat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$D_\ell$&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
    <span class="n">ax_dat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\ell$&#39;</span><span class="p">)</span>
<span class="n">ax_dat</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
<span class="n">fig_dat</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">tmpplot</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Iteration&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_dat</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                 <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

<span class="n">fig_dat</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;90$\times$150 GHz total power fit&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[50]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 0.98, &#39;90$\\times$150 GHz total power fit&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_110_1.png" src="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_110_1.png" />
</div>
</div>
<p>Now let’s look at just the <span class="math notranslate nohighlight">\(q_b\)</span> values for each of the different component and see how they converge as a function of iteration and bin. The lowest bins tend to have the biggest moves, but for all components, everything gets close to its final value within a handful of iterations.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[51]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">### Figure for looking at how qb for each bandpower changes with iteration</span>
<span class="n">figtmp</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">figure</span><span class="p">()</span>
<span class="n">tmpplot</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)),</span> <span class="n">cmap</span><span class="o">=</span><span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;viridis&#39;</span><span class="p">),</span><span class="n">vmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="nb">len</span><span class="p">(</span><span class="n">iters</span><span class="p">))</span>
<span class="n">plt</span><span class="o">.</span><span class="n">close</span><span class="p">(</span><span class="n">figtmp</span><span class="p">)</span>
<span class="n">specs</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;tt&#39;</span><span class="p">,</span> <span class="s1">&#39;ee&#39;</span><span class="p">,</span> <span class="s1">&#39;bb&#39;</span><span class="p">,</span> <span class="s1">&#39;te&#39;</span><span class="p">,</span> <span class="s1">&#39;tb&#39;</span><span class="p">,</span> <span class="s1">&#39;eb&#39;</span><span class="p">]</span>
<span class="n">colors</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">cm</span><span class="o">.</span><span class="n">get_cmap</span><span class="p">(</span><span class="s1">&#39;viridis&#39;</span><span class="p">,</span> <span class="nb">len</span><span class="p">(</span><span class="n">iters</span><span class="p">))</span><span class="o">.</span><span class="n">colors</span>
<span class="n">scatter</span> <span class="o">=</span> <span class="mf">1.</span> <span class="o">/</span> <span class="mf">50.</span>
<span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cmb&#39;</span><span class="p">]:</span>
    <span class="n">fig_dat</span><span class="p">,</span> <span class="n">ax_dat</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
    <span class="n">fig_dat</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="n">comp</span><span class="o">+</span><span class="sa">r</span><span class="s1">&#39; $q_b$ vs. iteration&#39;</span><span class="p">)</span>
    <span class="n">ax_dat</span> <span class="o">=</span> <span class="n">ax_dat</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
        <span class="n">ax_dat</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">ax_dat</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bp0</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iters</span><span class="p">):</span>
        <span class="n">b</span> <span class="o">=</span> <span class="n">xf</span><span class="o">.</span><span class="n">load_and_parse</span><span class="p">(</span><span class="n">bp0</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
            <span class="n">ax_dat</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">20</span><span class="p">)</span> <span class="o">+</span> <span class="n">scatter</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span>
                              <span class="n">b</span><span class="p">[</span><span class="s1">&#39;qb&#39;</span><span class="p">][</span><span class="n">comp</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">spec</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
        <span class="n">ax_dat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$q_b$&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">):</span>
        <span class="n">ax_dat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;bin&#39;</span><span class="p">)</span>

    <span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
    <span class="n">fig_dat</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">tmpplot</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Iteration&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_dat</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                     <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>

</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_112_0.png" src="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_112_0.png" />
</div>
</div>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1"># Now plot residuals</span>
<span class="n">fig_dat</span><span class="p">,</span> <span class="n">ax_dat</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">10</span><span class="p">,</span><span class="mi">8</span><span class="p">))</span>
<span class="n">fig_dat</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;res $q_b$ vs. iteration&#39;</span><span class="p">)</span>
<span class="n">ax_dat</span> <span class="o">=</span> <span class="n">ax_dat</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
<span class="n">maps</span> <span class="o">=</span> <span class="p">[</span><span class="n">x</span> <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="n">b</span><span class="p">[</span><span class="s1">&#39;qb&#39;</span><span class="p">]</span> <span class="k">if</span> <span class="s1">&#39;res&#39;</span> <span class="ow">in</span> <span class="n">x</span><span class="p">]</span>
<span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">m0</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">maps</span><span class="p">):</span>
    <span class="n">ax_dat</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">m0</span><span class="p">)</span>
    <span class="n">ax_dat</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">axhline</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">color</span><span class="o">=</span><span class="s1">&#39;gray&#39;</span><span class="p">,</span> <span class="n">alpha</span><span class="o">=</span><span class="mf">0.7</span><span class="p">)</span>
    <span class="n">ax_dat</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylim</span><span class="p">(</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="mi">2</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span><span class="p">,</span> <span class="n">bp0</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">iters</span><span class="p">):</span>
    <span class="n">b</span> <span class="o">=</span> <span class="n">xf</span><span class="o">.</span><span class="n">load_and_parse</span><span class="p">(</span><span class="n">bp0</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">m0</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">maps</span><span class="p">):</span>
        <span class="n">ax_dat</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">scatter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="mi">5</span><span class="p">)</span> <span class="o">+</span> <span class="n">scatter</span> <span class="o">*</span> <span class="n">i</span><span class="p">,</span>
                          <span class="n">b</span><span class="p">[</span><span class="s1">&#39;qb&#39;</span><span class="p">][</span><span class="n">m0</span><span class="p">],</span> <span class="n">color</span><span class="o">=</span><span class="n">colors</span><span class="p">[</span><span class="n">i</span><span class="p">],</span> <span class="n">s</span><span class="o">=</span><span class="mi">4</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
    <span class="n">ax_dat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$q_b$&#39;</span><span class="p">)</span>
<span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">ax_dat</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="s1">&#39;bin&#39;</span><span class="p">)</span>

<span class="n">plt</span><span class="o">.</span><span class="n">subplots_adjust</span><span class="p">(</span><span class="n">wspace</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">hspace</span><span class="o">=</span><span class="mf">0.01</span><span class="p">)</span>
<span class="n">fig_dat</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">tmpplot</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Iteration&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax_dat</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                 <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[52]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
&lt;matplotlib.colorbar.Colorbar at 0x7f79f800d790&gt;
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_113_1.png" src="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_113_1.png" />
</div>
</div>
<p>Now that everything has converged, let’s plot up what the final bandpowers and error bars look like. XFaster saves the binned bandpowers as <span class="math notranslate nohighlight">\(D_\ell\)</span>s, though they are labeled <code class="docutils literal notranslate"><span class="pre">cb</span></code>. The error bars are in <code class="docutils literal notranslate"><span class="pre">dcb</span></code>, and those are also computed without sample variance in <code class="docutils literal notranslate"><span class="pre">dcb_nosampvar</span></code>. Covariance is in <code class="docutils literal notranslate"><span class="pre">cov</span></code>, and it also has a no sample variance version, <code class="docutils literal notranslate"><span class="pre">cov_nosampvar</span></code>. I’ll plot up the starting models as well to see how far XFaster had to adjust to match the data.</p>
<p>To calculate error bars and covariances without sample variance, XFaster just does one final calculation of the Fisher matrix (after everything has converged), with all the <span class="math notranslate nohighlight">\(q_b\)</span>s set to a very small number, thereby nulling out the signal. The error bars and covariance without sample variance come from that Fisher matrix.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[53]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="c1">#bp = xf.load_and_parse(&#39;/mnt/scratch1/spectra_spider_planck/sp_pl/bandpowers_sp_pl.npz&#39;)</span>
<span class="k">for</span> <span class="n">comp</span> <span class="ow">in</span> <span class="p">[</span><span class="s1">&#39;cmb&#39;</span><span class="p">]:</span>
    <span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span><span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">20</span><span class="p">,</span><span class="mi">15</span><span class="p">))</span>
    <span class="n">ax</span> <span class="o">=</span> <span class="n">ax</span><span class="o">.</span><span class="n">flatten</span><span class="p">()</span>
    <span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;</span><span class="si">{}</span><span class="s1"> final estimated bandpowers&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">s</span><span class="p">,</span> <span class="n">spec</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">specs</span><span class="p">):</span>
        <span class="n">sn</span> <span class="o">=</span> <span class="s1">&#39;</span><span class="si">{}</span><span class="s1">_</span><span class="si">{}</span><span class="s1">&#39;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="n">comp</span><span class="p">,</span> <span class="n">spec</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="n">spec</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">plot</span><span class="p">(</span><span class="n">lfac</span> <span class="o">*</span> <span class="n">signal_shape</span><span class="p">[</span><span class="n">sn</span><span class="p">][:</span><span class="mi">501</span><span class="p">],</span> <span class="s1">&#39;k-&#39;</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Model&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">bp</span><span class="p">[</span><span class="s1">&#39;ellb&#39;</span><span class="p">][</span><span class="n">sn</span><span class="p">],</span> <span class="n">bp</span><span class="p">[</span><span class="s1">&#39;cb&#39;</span><span class="p">][</span><span class="n">sn</span><span class="p">],</span> <span class="n">bp</span><span class="p">[</span><span class="s1">&#39;dcb&#39;</span><span class="p">][</span><span class="n">sn</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;sampvar&#39;</span><span class="p">)</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">s</span><span class="p">]</span><span class="o">.</span><span class="n">errorbar</span><span class="p">(</span><span class="n">bp</span><span class="p">[</span><span class="s1">&#39;ellb&#39;</span><span class="p">][</span><span class="n">sn</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span> <span class="n">bp</span><span class="p">[</span><span class="s1">&#39;cb&#39;</span><span class="p">][</span><span class="n">sn</span><span class="p">],</span> <span class="n">bp</span><span class="p">[</span><span class="s1">&#39;dcb_nosampvar&#39;</span><span class="p">][</span><span class="n">sn</span><span class="p">],</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;no sampvar&#39;</span><span class="p">)</span>
    <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">legend</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">4</span><span class="p">]:</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_ylabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$D_\ell$&#39;</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">i</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">4</span><span class="p">,</span><span class="mi">5</span><span class="p">]:</span>
        <span class="n">ax</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="o">.</span><span class="n">set_xlabel</span><span class="p">(</span><span class="sa">r</span><span class="s1">&#39;$\ell$&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_115_0.png" src="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_115_0.png" />
</div>
</div>
<p>The error bars are just the diagonal of the covariance matrix. Is this a good approximation for our real error? Let’s look at the covariance matrix with and without sample variance.</p>
<div class="nbinput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="input_area highlight-ipython3 notranslate"><div class="highlight"><pre>
<span></span><span class="kn">from</span> <span class="nn">matplotlib.colors</span> <span class="kn">import</span> <span class="n">LogNorm</span>
<span class="n">norm</span> <span class="o">=</span> <span class="n">LogNorm</span><span class="p">(</span><span class="n">vmin</span><span class="o">=</span><span class="mi">10</span><span class="p">,</span> <span class="n">vmax</span><span class="o">=</span><span class="mf">1e4</span><span class="p">)</span>
<span class="n">fig</span><span class="p">,</span> <span class="n">ax</span> <span class="o">=</span> <span class="n">plt</span><span class="o">.</span><span class="n">subplots</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">figsize</span><span class="o">=</span><span class="p">(</span><span class="mi">15</span><span class="p">,</span><span class="mi">10</span><span class="p">))</span>
<span class="n">fig</span><span class="o">.</span><span class="n">suptitle</span><span class="p">(</span><span class="s1">&#39;Covariance&#39;</span><span class="p">)</span>
<span class="n">p</span> <span class="o">=</span> <span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">bp</span><span class="p">[</span><span class="s1">&#39;cov&#39;</span><span class="p">]),</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;With sample variance&#39;</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">imshow</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">bp</span><span class="p">[</span><span class="s1">&#39;cov_nosampvar&#39;</span><span class="p">]),</span> <span class="n">norm</span><span class="o">=</span><span class="n">norm</span><span class="p">)</span>
<span class="n">fig_dat</span><span class="o">.</span><span class="n">colorbar</span><span class="p">(</span><span class="n">p</span><span class="p">,</span> <span class="n">label</span><span class="o">=</span><span class="s1">&#39;Covariance&#39;</span><span class="p">,</span> <span class="n">ax</span><span class="o">=</span><span class="n">ax</span><span class="o">.</span><span class="n">ravel</span><span class="p">()</span><span class="o">.</span><span class="n">tolist</span><span class="p">(),</span>
                 <span class="n">orientation</span><span class="o">=</span><span class="s1">&#39;horizontal&#39;</span><span class="p">,</span> <span class="n">shrink</span><span class="o">=</span><span class="mf">0.5</span><span class="p">)</span>
<span class="n">ax</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">set_title</span><span class="p">(</span><span class="s1">&#39;Without sample variance&#39;</span><span class="p">)</span>
</pre></div>
</div>
</div>
<div class="nboutput docutils container">
<div class="prompt highlight-none notranslate"><div class="highlight"><pre><span></span>[54]:
</pre></div>
</div>
<div class="output_area docutils container">
<div class="highlight"><pre>
Text(0.5, 1.0, &#39;Without sample variance&#39;)
</pre></div></div>
</div>
<div class="nboutput nblast docutils container">
<div class="prompt empty docutils container">
</div>
<div class="output_area docutils container">
<img alt="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_117_1.png" src="notebooks/../_build/doctrees/nbsphinx/notebooks_XFaster_Tutorial_117_1.png" />
</div>
</div>
<p>This is a 120 x 120 bin matrix, with each of the 20 bins for each spectrum in order (TT, EE, BB, TE, EB, TB).</p>
</div>
<div class="section" id="Other-useful-things">
<h2>Other useful things<a class="headerlink" href="#Other-useful-things" title="Permalink to this headline">¶</a></h2>
<ul class="simple">
<li><p><strong>Null tests</strong></p></li>
<li><p>To run a null test, you just provide two data roots (<code class="docutils literal notranslate"><span class="pre">data_root</span></code> and <code class="docutils literal notranslate"><span class="pre">data_root2</span></code>) corresponding to the map directories of the two halves of the null.</p></li>
<li><p>When XFaster is computing <span class="math notranslate nohighlight">\(\mathcal{C}_\ell\)</span>s from signal sims, noise sims, and data, it loads up both maps, and then computes the spectrum both of (map1+map2)/2 and (map1-map2)/2. It uses the former to compute transfer functions, and the latter for bandpowers.</p></li>
<li><p>The model spectrum fit for is flat in <span class="math notranslate nohighlight">\(D_\ell\)</span> with an amplitude of 1e-5 (0 causes singular matrix problems in the Fisher computation).</p></li>
<li><p><strong>Foreground sims</strong></p></li>
<li><p>If you have some foreground sims, say from PySM sitting on disk, and you want XFaster to add them to a CMB signal sim, then in addition to setting <code class="docutils literal notranslate"><span class="pre">sim_index</span></code> to your desired CMB signal sim index, set <code class="docutils literal notranslate"><span class="pre">foreground_type</span></code>. This argument works the same way as <code class="docutils literal notranslate"><span class="pre">clean_type</span></code>– it looks for maps in the directory in your data root in the folder <code class="docutils literal notranslate"><span class="pre">foreground_&lt;foreground_type&gt;</span></code> that match the map tags you asked for in <code class="docutils literal notranslate"><span class="pre">data_subset</span></code>.</p></li>
<li><p><code class="docutils literal notranslate"><span class="pre">noise_type_sim</span></code></p></li>
<li><p>SPIDER’s noise sims aren’t a super good estimate of our actual noise. That’s why we fit for noise residuals! If you want to run a sim that tests how well this works, you can use a different noise sim than one from your ensemble used to calculate <span class="math notranslate nohighlight">\(&lt;N_\ell&gt;\)</span> when doing a <code class="docutils literal notranslate"><span class="pre">sim_index</span></code> run. Feed the tag for the other noise sim directory to <code class="docutils literal notranslate"><span class="pre">noise_type_sim</span></code> (works just like <code class="docutils literal notranslate"><span class="pre">noise_type</span></code>) to use a sim with the same sim index from that directory instead.</p></li>
</ul>
</div>
</div>


           </div>
           
          </div>
          <footer>
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
        <a href="../api.html" class="btn btn-neutral float-right" title="API Reference" accesskey="n" rel="next">Next <span class="fa fa-arrow-circle-right" aria-hidden="true"></span></a>
        <a href="../algorithm.html" class="btn btn-neutral float-left" title="Algorithm" accesskey="p" rel="prev"><span class="fa fa-arrow-circle-left" aria-hidden="true"></span> Previous</a>
    </div>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2021, A. Gambrel, A. Rahlin, C. Contaldi.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>